# AI Agent ç¼–ç è§„èŒƒ

## Shell è„šæœ¬è§„èŒƒ

### è¾“å‡ºé‡å®šå‘è§„åˆ™

1. **ä¸è¦ä¸¢å¼ƒå­è„šæœ¬æˆ–å‘½ä»¤çš„è¾“å‡º**ï¼šä¿ç•™è¾“å‡ºå¯è§æ€§ï¼ŒåŒæ—¶ä¸æ±¡æŸ“ stdoutâ€”â€”å°†è¾“å‡ºé‡å®šå‘åˆ° stderr (`>&2`)ï¼Œè€Œä¸æ˜¯ä¸¢å¼ƒåˆ° `/dev/null`ã€‚

   ```bash
   # âŒ é”™è¯¯ï¼šä¸¢å¼ƒè¾“å‡ºï¼ˆè°ƒè¯•ä¿¡æ¯å®Œå…¨ä¸¢å¤±ï¼‰
   _verify_checksum "$file" "$checksum" 2>/dev/null
   some_command &>/dev/null

   # âœ… æ­£ç¡®ï¼šé‡å®šå‘åˆ° stderrï¼ˆä¿æŒ stdout å¹²å‡€ï¼ŒåŒæ—¶è¾“å‡ºä»å¯è§ï¼‰
   _verify_checksum "$file" "$checksum" >&2
   some_command >&2
   ```

2. **å…è®¸ä¸¢å¼ƒè¾“å‡ºçš„ä¾‹å¤–æƒ…å†µ**ï¼š
   - `grep -q` æ£€æŸ¥æ–‡ä»¶å†…å®¹æ—¶ï¼ˆæ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨ï¼‰ï¼š`grep -q 'pattern' file 2>/dev/null`
   - `dpkg --status` æ£€æŸ¥åŒ…æ˜¯å¦å®‰è£…æ—¶ï¼ˆåªå…³å¿ƒé€€å‡ºç ï¼‰
   - `nohup ... &` åå°è¿›ç¨‹
   - `tee > /dev/null` é¿å…é‡å¤è¾“å‡ºåˆ°ç»ˆç«¯

3. **è„šæœ¬ä¸­çš„æ‰€æœ‰ç”¨æˆ·æç¤ºä¿¡æ¯éƒ½åº”è¾“å‡ºåˆ° stderr**ï¼š
   ```bash
   echo "ğŸ” æ­£åœ¨è·å–ç‰ˆæœ¬ä¿¡æ¯..." >&2
   echo "âœ… å®‰è£…æˆåŠŸ" >&2
   ```

## bin-priority ç›®å½•

`/usr/local/bin-priority` ç›®å½•ç”¨äºå­˜æ”¾**æŒ‰éœ€è‡ªåŠ¨å®‰è£…**çš„è„šæœ¬ï¼Œä¼˜å…ˆçº§é«˜äºç³»ç»Ÿ PATHã€‚

### ç›®çš„

å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è¿è¡ŒæŸä¸ªå‘½ä»¤æ—¶ï¼Œå¦‚æœè¯¥å·¥å…·æœªå®‰è£…ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…å®ƒï¼Œç„¶åè½¬å‘æ‰§è¡ŒçœŸæ­£çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ç”¨æˆ·æ— éœ€æ‰‹åŠ¨å®‰è£…ï¼Œç›´æ¥ä½¿ç”¨å‘½ä»¤å³å¯è§¦å‘è‡ªåŠ¨å®‰è£…ã€‚

### è„šæœ¬ç±»å‹

1. **APT è‡ªåŠ¨å®‰è£… shim**ï¼šé€šè¿‡ `dpkg --status` æ£€æµ‹ + `_apt-install-cached` å®‰è£… + `_exec-real-bin` è½¬å‘
   - ç¤ºä¾‹ï¼š`jq`ã€`ffmpeg`ã€`ffprobe`ã€`vim`ã€`htop`ã€`tree`ã€`less`ã€`unzip`ã€`gh`ã€`magick`ã€`ncdu`ã€`hyperfine` ç­‰
   - æœ€ç®€æ´çš„ç±»å‹ï¼Œæ—  `_print_caller_info`
   - å°‘æ•°æœ‰é¢å¤–é…ç½®ï¼ˆå¦‚ `tmux` ä¼šåˆ›å»ºé»˜è®¤ `~/.tmux.conf`ï¼‰

2. **h-setup çº¯ shim å«ç‰‡**ï¼šé€šè¿‡ `_get-real-bin --silent` æ£€æµ‹ + `h-setup-*-bin` å®‰è£… + `_exec-real-bin` è½¬å‘
   - ç¤ºä¾‹ï¼š`bun`ã€`node`ã€`npx`ã€`pnpm`ã€`uv`ã€`uvx`ã€`pip3`
   - ä½¿ç”¨ `_print_caller_info` åˆ†ç»„è¾¹æ¡†
   - éƒ¨åˆ†è„šæœ¬è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¦‚ `uv`/`uvx` è®¾ç½® `UV_CACHE_DIR`ï¼‰

3. **åŒ…è£…å™¨/å¯åŠ¨å™¨**ï¼šé€šè¿‡ `add-bun-priority-bin-pkg` å®‰è£… npm åŒ… + é¢å¤–é…ç½®/å‚æ•°å¤„ç† + æ‰§è¡Œ
   - ç¤ºä¾‹ï¼š`claude`ã€`gemini`ã€`codex`ã€`qwen`ã€`iflow`ã€`opencode`ã€`typescript-language-server`
   - å®‰è£…åˆ° `/vscode/bun-priority-bin/`ï¼Œä½¿ç”¨ `bun --bun run` æˆ–ç›´æ¥æ‰§è¡ŒäºŒè¿›åˆ¶
   - åŒ…å«é…ç½®åˆå§‹åŒ–ã€ç¯å¢ƒå˜é‡è®¾ç½®ã€`_ensure-vscode-symlink` ç¬¦å·é“¾æ¥ã€CLI å‚æ•°æ³¨å…¥ç­‰é¢å¤–é€»è¾‘
   - ä½¿ç”¨ `_print_caller_info`ï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨ `_print_group_end`

4. **ç®€å•é‡å®šå‘**ï¼šç›´æ¥ `exec` è½¬å‘åˆ°å¦ä¸€ä¸ªå‘½ä»¤ï¼Œæ— å®‰è£…æ£€æµ‹
   - `pip` â†’ `pip3`ã€`python` â†’ `python3`
   - `systemctl` â†’ æ£€æµ‹ systemd å¯ç”¨æ€§ï¼Œå›é€€åˆ° `service`

5. **ç‰¹æ®Šå·¥å…·è„šæœ¬**ï¼šç‹¬ç«‹é€»è¾‘ï¼Œä¸éµå¾ªç»Ÿä¸€æ¨¡æ¿
   - `code` â€” æŸ¥æ‰¾ `code`/`code-insiders` äºŒè¿›åˆ¶çš„å›é€€é€»è¾‘
   - `claude-statusline` â€” è§£æ JSON æ ¼å¼åŒ– Claude Code çŠ¶æ€è¡Œ
   - `claude-switch-settings` â€” äº¤äº’å¼èœå•åˆ‡æ¢ Claude é…ç½®æ–‡ä»¶

### åˆ†ç»„è¾¹æ¡†æœºåˆ¶

`_print_caller_info` ä¼šæ‰“å°é¡¶éƒ¨è¾¹æ¡† `â•­â”€â”€â•®`ï¼Œ`_print_group_end` æ‰“å°åº•éƒ¨è¾¹æ¡† `â•°â”€â”€â•¯`ï¼Œä½¿æ¯æ¬¡ shim è°ƒç”¨çš„è¾“å‡ºå½¢æˆä¸€ä¸ªè§†è§‰æ•´ä½“ã€‚

- **h-setup çº¯ shim å«ç‰‡**ï¼š`_exec-real-bin` ä¼šè‡ªåŠ¨è°ƒç”¨ `_print_group_end`ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
- **APT è‡ªåŠ¨å®‰è£… shim**ï¼šä¸ä½¿ç”¨ `_print_caller_info`ï¼Œæ— éœ€å¤„ç†è¾¹æ¡†
- **åŒ…è£…å™¨/å¯åŠ¨å™¨**ï¼šå¦‚æœä½¿ç”¨äº† `_print_caller_info` ä½†ä¸é€šè¿‡ `_exec-real-bin` æ‰§è¡Œï¼Œéœ€åœ¨ `exec` å‰æ‰‹åŠ¨è°ƒç”¨ `_print_group_end`
- **å¼‚å¸¸é€€å‡º**ï¼š`_print_caller_info` è®¾ç½®äº† EXIT trapï¼Œè„šæœ¬é”™è¯¯é€€å‡ºæ—¶ä¼šè‡ªåŠ¨å…³é—­è¾¹æ¡†
- **åµŒå¥—è°ƒç”¨**ï¼šå½“ shim åœ¨å¦ä¸€ä¸ª shim å†…éƒ¨è¢«è§¦å‘æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ `â”„â”„â”„` è™šçº¿åˆ†éš”ï¼ˆè€Œéæ–°å¼€ç›’å­ï¼‰ï¼Œå­ shim çš„è¾“å‡ºåˆå¹¶åœ¨çˆ¶çº§ç›’å­å†…

### å¼€å‘æµç¨‹

**é‡è¦**ï¼šæ‰€æœ‰ shim è„šæœ¬å¿…é¡»å…ˆæ·»åŠ åˆ°é¡¹ç›®æºç ç›®å½•ï¼Œå†é€šè¿‡è„šæœ¬å¤åˆ¶åˆ°ç³»ç»Ÿç›®å½•ã€‚

1. **æºç ç›®å½•**ï¼š`.devcontainer/_build-context/rootfs/usr/local/bin-priority/`
2. **å¤åˆ¶è„šæœ¬**ï¼šè¿è¡Œ `scripts/cp-bins` å°†æºç ç›®å½•åŒæ­¥åˆ° `/usr/local/bin-priority/`

```bash
# æ·»åŠ æ–° shim åï¼Œè¿è¡Œå¤åˆ¶è„šæœ¬
scripts/cp-bins
```

### ç¼–å†™æ–°çš„ shim è„šæœ¬

å‚è€ƒæ¨¡æ¿ï¼ˆä»…é€‚ç”¨äº **h-setup çº¯ shim å«ç‰‡**ï¼Œä¸é€‚ç”¨äºåŒ…è£…å™¨/å¯åŠ¨å™¨ï¼‰ï¼š
```bash
#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

# <tool> shim: è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£… <tool>ï¼Œç„¶åæ‰§è¡Œ

source /devcontainer/shim-utils.sh
_print_caller_info

<tool>_bin="$(_get-real-bin --silent <tool>)"

if [ -z "$<tool>_bin" ]; then
    echo "âš ï¸  <tool> æœªå®‰è£…ï¼Œæ­£åœ¨è‡ªåŠ¨å®‰è£…..." >&2
    h-setup-<tool>-bin >&2
fi

exec _exec-real-bin <tool> "$@"
```

### ä½¿ç”¨ apt åŒ…çš„ shim æ¨¡æ¿

å¯¹äºé€šè¿‡ apt å®‰è£…çš„å·¥å…·ï¼ˆå¦‚ `jq`ã€`ffmpeg`ã€`htop` ç­‰ï¼‰ï¼Œä½¿ç”¨æ›´ç®€æ´çš„æ¨¡æ¿ï¼š
```bash
#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

if false; then
#-------------------------------------------------------------------------------
# <tool>: <ç®€çŸ­æè¿°>
# ç¤ºä¾‹ï¼š
<tool> <ç¤ºä¾‹å‘½ä»¤1>
<tool> <ç¤ºä¾‹å‘½ä»¤2>
#-------------------------------------------------------------------------------
fi

if ! dpkg --status <package> &>/dev/null; then
  _apt-install-cached <package> >&2
fi

exec _exec-real-bin <tool> "$@"
```

**æ³¨æ„**ï¼š`if false` å—ä¸­çš„æ³¨é‡Šä¸ä¼šè¢«æ£€æŸ¥å™¨æŠ¥é”™ï¼ŒåŒæ—¶ä¿ç•™äº†ä½¿ç”¨æ–‡æ¡£ã€‚
