#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# https://github.com/anthropics/claude-code/blob/1fe9e369a7c30805189cbbb72eb69c15ed4ec96b/.devcontainer/Dockerfile#L42
# https://code.claude.com/docs/zh-CN/settings#å¯ç”¨è®¾ç½®
# https://code.claude.com/docs/zh-CN/settings#ç¯å¢ƒå˜é‡
# https://code.claude.com/docs/zh-CN/statusline

#-------------------------------------------------------------------------------------------------------------
# ANTHROPIC_AUTH_TOKEN
# ANTHROPIC_BASE_URL

# ç›´æ¥æŒ‡å®šå½“å‰ä½¿ç”¨çš„æ¨¡å‹
# ANTHROPIC_MODEL

# ç”¨äº haiku çš„æ¨¡å‹ï¼Œæˆ–åå°åŠŸèƒ½
# ANTHROPIC_DEFAULT_HAIKU_MODEL=claude-haiku-4-5-20251001

# ç”¨äº opus çš„æ¨¡å‹ï¼Œæˆ–åœ¨è®¡åˆ’æ¨¡å¼æ´»è·ƒæ—¶ç”¨äº opusplan çš„æ¨¡å‹ã€‚
# ANTHROPIC_DEFAULT_OPUS_MODEL=claude-opus-4-5-20251101

# ç”¨äº sonnet çš„æ¨¡å‹ï¼Œæˆ–åœ¨è®¡åˆ’æ¨¡å¼ä¸æ´»è·ƒæ—¶ç”¨äº opusplan çš„æ¨¡å‹ã€‚
# ANTHROPIC_DEFAULT_SONNET_MODEL=claude-sonnet-4-5-20250929

# CLAUDE_CODE_SUBAGENT_MODEL	ç”¨äºå­ä»£ç†çš„æ¨¡å‹

# "apiKeyHelper": "/bin/generate_temp_api_key.sh",
#-------------------------------------------------------------------------------------------------------------


# è·å–è°ƒç”¨è€…ä¿¡æ¯
PARENT_INFO=$(ps -p $PPID -o args= 2>/dev/null || echo "unknown")

# è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ --skip-settings
CLAUDE_ARGS=()
SKIP_SETTINGS_MSG=""
for arg in "$@"; do
  if [[ "$arg" == "--skip-settings" ]]; then
    export CLAUDE_SKIP_SETTINGS=1
    SKIP_SETTINGS_MSG=" | â­ï¸ --skip-settings"
  else
    CLAUDE_ARGS+=("$arg")
  fi
done
set -- "${CLAUDE_ARGS[@]}"

echo "ğŸš€ æ­£åœ¨è¿è¡Œ Claude Code åŒ…è£…å™¨ ($0)"
echo "   è°ƒç”¨è€…: $PARENT_INFO (PID: $PPID)${SKIP_SETTINGS_MSG}"

add-bun-priority-bin-pkg @anthropic-ai/claude-code@latest


# åˆå§‹åŒ– Claude Code é…ç½®æ–‡ä»¶
init_claude_config() {
  local config_file="/vscode/claude-config/.claude.json"
  local updated=0
  
  mkdir -p "$(dirname "$config_file")"
  
  # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©º JSON å¯¹è±¡
  if [[ ! -f "$config_file" ]]; then
    echo '{}' > "$config_file"
    updated=1
  fi
  
  # è¯»å–å½“å‰é…ç½®
  local current_config
  current_config=$(cat "$config_file")
  
  # æ£€æŸ¥å¹¶è®¾ç½® numStartups
  if ! echo "$current_config" | jq -e 'has("numStartups")' > /dev/null 2>&1; then
    current_config=$(echo "$current_config" | jq '.numStartups = 0')
    updated=1
  fi
  
  # æ£€æŸ¥å¹¶è®¾ç½® theme
  if ! echo "$current_config" | jq -e 'has("theme")' > /dev/null 2>&1; then
    current_config=$(echo "$current_config" | jq '.theme = "light-daltonized"')
    updated=1
  fi
  
  # æ£€æŸ¥å¹¶è®¾ç½® bypassPermissionsModeAccepted
  if ! echo "$current_config" | jq -e 'has("bypassPermissionsModeAccepted")' > /dev/null 2>&1; then
    current_config=$(echo "$current_config" | jq '.bypassPermissionsModeAccepted = true')
    updated=1
  fi
  
  # æ£€æŸ¥å¹¶è®¾ç½® hasCompletedOnboarding
  if ! echo "$current_config" | jq -e 'has("hasCompletedOnboarding")' > /dev/null 2>&1; then
    current_config=$(echo "$current_config" | jq '.hasCompletedOnboarding = true')
    updated=1
  fi
  
  # å¦‚æœæœ‰æ›´æ–°ï¼Œå†™å…¥æ–‡ä»¶
  if [[ $updated -eq 1 ]]; then
    echo "$current_config" > "$config_file"
    echo "âš™ï¸  å·²åˆå§‹åŒ–é…ç½®æ–‡ä»¶: $config_file"
  fi
}

# é€‰æ‹© settings æ–‡ä»¶
# è®¾ç½®ç¯å¢ƒå˜é‡ CLAUDE_SKIP_SETTINGS=1 å¯è·³è¿‡é€‰æ‹©
# æˆ–ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•° --skip-settings
select_settings_file() {
  if [[ "${CLAUDE_SKIP_SETTINGS:-}" == "1" ]]; then
    echo "â­ï¸  å·²è·³è¿‡é€‰æ‹© settings æ–‡ä»¶ (CLAUDE_SKIP_SETTINGS=1)"
    return
  fi

  # è°ƒç”¨ç‹¬ç«‹çš„ claude-switch-settings è„šæœ¬
  # ä½¿ç”¨ source ä»¥ä¾¿è·å– SELECTED_SETTINGS_FILE ç¯å¢ƒå˜é‡
  local switch_script
  switch_script="$(get_switch_settings_path)"
  if [[ -n "$switch_script" ]]; then
    source "$switch_script"
  else
    echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ° claude-switch-settings è„šæœ¬"
  fi
}

# è·å– claude-switch-settings è„šæœ¬çš„è·¯å¾„
get_switch_settings_path() {
  local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -x "$script_dir/claude-switch-settings" ]]; then
    echo "$script_dir/claude-switch-settings"
  elif command -v claude-switch-settings &>/dev/null; then
    command -v claude-switch-settings
  fi
}

# è·å– claude-statusline è„šæœ¬çš„è·¯å¾„
get_statusline_path() {
  local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -x "$script_dir/claude-statusline" ]]; then
    echo "$script_dir/claude-statusline"
  elif command -v claude-statusline &>/dev/null; then
    command -v claude-statusline
  else
    echo "claude-statusline"
  fi
}

# è®¾ç½® Claude Code çš„æ‰˜ç®¡é…ç½®
setup_managed_settings() {
  local announcements=()
  local target_settings_file="/vscode/claude-config/settings.json"

  if [[ -f "$target_settings_file" ]]; then
    local extracted_url
    local extracted_model
    local extracted_opus_model
    local extracted_sonnet_model
    local extracted_haiku_model
    
    extracted_url=$(jq -r '.env.ANTHROPIC_BASE_URL // empty' "$target_settings_file" 2>/dev/null)
    extracted_model=$(jq -r '.env.ANTHROPIC_MODEL // empty' "$target_settings_file" 2>/dev/null)
    extracted_opus_model=$(jq -r '.env.ANTHROPIC_DEFAULT_OPUS_MODEL // empty' "$target_settings_file" 2>/dev/null)
    extracted_sonnet_model=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL // empty' "$target_settings_file" 2>/dev/null)
    extracted_haiku_model=$(jq -r '.env.ANTHROPIC_DEFAULT_HAIKU_MODEL // empty' "$target_settings_file" 2>/dev/null)
    
    if [[ -n "$extracted_url" ]]; then
      announcements+=("ğŸš€         API: $extracted_url")
    fi
    if [[ -n "$extracted_model" ]]; then
      announcements+=("ğŸ¤–    é»˜è®¤æ¨¡å‹: $extracted_model")
    fi
    if [[ -n "$extracted_opus_model" ]]; then
      announcements+=("ğŸ§    Opus æ¨¡å‹: $extracted_opus_model")
    fi
    if [[ -n "$extracted_sonnet_model" ]]; then
      announcements+=("ğŸµ Sonnet æ¨¡å‹: $extracted_sonnet_model")
    fi
    if [[ -n "$extracted_haiku_model" ]]; then
      announcements+=("ğŸ‡  Haiku æ¨¡å‹: $extracted_haiku_model")
    fi
  fi

  if [[ -n "${SELECTED_SETTINGS_FILE:-}" ]]; then
      announcements+=("ğŸ“„ $(basename "$SELECTED_SETTINGS_FILE")")
  fi

  # å¦‚æœæ²¡æœ‰ä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·
  if [[ ${#announcements[@]} -eq 0 ]]; then
    announcements+=("âš ï¸ æœªæ‰¾åˆ°é…ç½®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ settings æ–‡ä»¶ã€‚")
  fi

  # åˆå¹¶æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨ \n åˆ†éš”
  # æŸ¥æ‰¾ claude-switch-settings è„šæœ¬çš„å®é™…è·¯å¾„
  local switch_script_path
  switch_script_path="$(get_switch_settings_path)"

  # å¦‚æœ switch_script_path ä»¥å½“å‰å·¥ä½œç›®å½•å¼€å¤´ï¼Œåˆ™ç§»é™¤è¯¥å‰ç¼€
  if [[ "$switch_script_path" == "$PWD"* ]]; then
    switch_script_path="${switch_script_path#$PWD/}"
  fi
  
  local combined_announcement=""
  local separator="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  if [[ -n "$switch_script_path" ]]; then
    combined_announcement="ğŸ’¡ åˆ‡æ¢é…ç½®: $switch_script_path\n$separator"
  else
    combined_announcement="ğŸ’¡ åˆ‡æ¢é…ç½®: claude-switch-settings\n$separator"
  fi
  for item in "${announcements[@]}"; do
    combined_announcement="${combined_announcement}\n${item}"
  done
  
  # è½¬ä¹‰åŒå¼•å·
  combined_announcement="${combined_announcement//\"/\\\"}"

  # è·å– claude-statusline çš„å®é™…è·¯å¾„
  local statusline_path
  statusline_path="$(get_statusline_path)"

  local settings_json='{
  "companyAnnouncements": ["'"$combined_announcement"'"],
  "defaultMode": "bypassPermissions",
  "statusLine": {
    "type": "command",
    "command": "'"$statusline_path"'",
    "padding": 0
  }
}'
  
  sudo mkdir -p /etc/claude-code
  
  local target_file="/etc/claude-code/managed-settings.json"
  local current_content=""
  if [[ -f "$target_file" ]]; then
    current_content=$(cat "$target_file")
  fi
  
  if [[ "$settings_json" != "$current_content" ]]; then
    echo "$settings_json" | sudo tee "$target_file" > /dev/null
    sudo chmod 666 "$target_file" # æ‰€æœ‰äººéƒ½å¯ä»¥è¯»å–å’Œå†™å…¥è¯¥æ–‡ä»¶,ä½†ä»»ä½•äººéƒ½ä¸èƒ½æ‰§è¡Œã€‚
    echo "âš™ï¸  å·²æ›´æ–°æ‰˜ç®¡é…ç½®: $target_file"
  else
    echo "âš™ï¸  æ‰˜ç®¡é…ç½®æ— å˜åŒ–: $target_file"
  fi
}

init_claude_config
# select_settings_file
setup_managed_settings


BUN_ARGS=("--bun")
BUN_ARGS+=("run")
# /vscode/bun-priority-bin/node_modules/@anthropic-ai/claude-code/cli.js
BUN_ARGS+=("/vscode/bun-priority-bin/node_modules/.bin/claude")

CLI_ARGS=("--dangerously-skip-permissions")

echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ: bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*"
# bun --bun --cwd=/vscode/bun-priority-bin/ run claude --version

# # ä» PATH ä¸­ç§»é™¤å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œé˜²æ­¢æ— é™é€’å½’
# SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# # åŒæ—¶ç§»é™¤ /usr/local/bin-priorityï¼Œå› ä¸ºè¿™æ˜¯å®‰è£…åçš„ä½ç½®
# export PATH=$(echo "$PATH" | sed "s|$SCRIPT_DIR||g; s|/usr/local/bin-priority||g; s|::|:|g; s|^:||; s|:$||")

exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
