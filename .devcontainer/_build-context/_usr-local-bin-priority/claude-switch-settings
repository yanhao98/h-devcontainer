#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# é€‰æ‹©å¹¶åˆ‡æ¢ Claude Code çš„ settings é…ç½®æ–‡ä»¶
# å°†é€‰ä¸­çš„ settings.*.json åˆå¹¶åˆ° /vscode/claude-config/settings.json

SETTINGS_DIR="/vscode/claude-config"
TARGET_SETTINGS_FILE="/vscode/claude-config/settings.json"

select_settings_file() {
  local settings_files=()

  # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
  if [[ ! -d "$SETTINGS_DIR" ]]; then
    echo "âš ï¸  è­¦å‘Š: ç›®å½• $SETTINGS_DIR ä¸å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½ settings æ–‡ä»¶"
    return 1
  fi

  # æŸ¥æ‰¾æ‰€æœ‰ settings.*.json æ–‡ä»¶
  while IFS= read -r -d '' file; do
    settings_files+=("$file")
  done < <(find "$SETTINGS_DIR" -maxdepth 1 -type f -name "settings.*.json" -print0 | sort -z)

  # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶
  if [[ ${#settings_files[@]} -eq 0 ]]; then
    echo "âš ï¸  è­¦å‘Š: åœ¨ $SETTINGS_DIR ä¸­æœªæ‰¾åˆ° settings.*.json æ–‡ä»¶ï¼Œè·³è¿‡åŠ è½½ settings æ–‡ä»¶"
    return 1
  fi

  local selected_file=""

  # å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨
  if [[ ${#settings_files[@]} -eq 1 ]]; then
    selected_file="${settings_files[0]}"
    echo "âœ… æ‰¾åˆ° settings æ–‡ä»¶: $selected_file"
  else
    # å¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œè®©ç”¨æˆ·é€‰æ‹©
    local selected_name
    local filenames=()
    for file in "${settings_files[@]}"; do
      filenames+=("$(basename "$file")")
    done

    # ä½¿ç”¨ fzf è¿›è¡Œé€‰æ‹©
    set +e # é¿å… fzf å–æ¶ˆæ—¶é€€å‡ºè„šæœ¬
    selected_name=$(printf "%s\n" "${filenames[@]}" | fzf --prompt="è¯·é€‰æ‹© settings æ–‡ä»¶: " --height=10 --layout=reverse)
    set -e

    if [[ -n "$selected_name" ]]; then
      selected_file="$SETTINGS_DIR/$selected_name"
      echo "âœ… å·²é€‰æ‹©: $selected_file"
    else
      echo "âš ï¸ æœªé€‰æ‹© settings æ–‡ä»¶ï¼Œè·³è¿‡åŠ è½½"
      return 1
    fi
  fi

  if [[ -n "$selected_file" ]]; then
    merge_settings "$selected_file"
  fi
}

merge_settings() {
  local selected_file="$1"
  
  export SELECTED_SETTINGS_FILE="$selected_file"
  
  # åˆå¹¶ settings æ–‡ä»¶åˆ° target_settings_file
  if [[ -f "$TARGET_SETTINGS_FILE" ]]; then
    echo "ğŸ”„ æ­£åœ¨åˆå¹¶ settings åˆ° $TARGET_SETTINGS_FILE ..."
    
    # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å… jq å¤±è´¥å¯¼è‡´åŸæ–‡ä»¶æŸå
    local temp_merged_file
    temp_merged_file=$(mktemp)

    # å°è¯•åˆå¹¶ã€‚å¦‚æœç›®æ ‡æ–‡ä»¶ä¸ºç©ºï¼Œå°†å…¶è§†ä¸º {}
    if [[ ! -s "$TARGET_SETTINGS_FILE" ]]; then
      echo "{}" > "$TARGET_SETTINGS_FILE"
    fi

    # å®šä¹‰éœ€è¦é‡ç½®çš„ç¯å¢ƒå˜é‡å­—æ®µï¼Œé˜²æ­¢æ—§é…ç½®æ®‹ç•™
    local reset_json='{
      "env": {
        "ANTHROPIC_AUTH_TOKEN": "",
        "ANTHROPIC_BASE_URL": "",
        "ANTHROPIC_MODEL": "",
        "ANTHROPIC_DEFAULT_HAIKU_MODEL": "",
        "ANTHROPIC_DEFAULT_OPUS_MODEL": "",
        "ANTHROPIC_DEFAULT_SONNET_MODEL": "",
        "CLAUDE_CODE_SUBAGENT_MODEL": ""
      }
    }'

    if jq -s --argjson reset "$reset_json" '.[0] * $reset * .[1]' "$TARGET_SETTINGS_FILE" "$selected_file" > "$temp_merged_file"; then
      mv "$temp_merged_file" "$TARGET_SETTINGS_FILE"
      chmod 666 "$TARGET_SETTINGS_FILE" 2>/dev/null || true # å°è¯•ç¡®ä¿æƒé™æ­£ç¡®
      echo "âœ… Settings åˆå¹¶æˆåŠŸ"
    else
      echo "âš ï¸ Settings åˆå¹¶å¤±è´¥ (JSON æ ¼å¼é”™è¯¯?)ï¼Œå°†ç›´æ¥è¦†ç›–åŸæ–‡ä»¶"
      cp "$selected_file" "$TARGET_SETTINGS_FILE"
      rm -f "$temp_merged_file"
    fi
  else
    echo "ğŸ“„ æ­£åœ¨å¤åˆ¶ settings åˆ° $TARGET_SETTINGS_FILE ..."
    cp "$selected_file" "$TARGET_SETTINGS_FILE"
  fi
  
  # æ˜¾ç¤ºå½“å‰é…ç½®ä¿¡æ¯
  echo ""
  echo "ğŸ“‹ å½“å‰é…ç½®:"
  local extracted_url extracted_model extracted_opus extracted_sonnet extracted_haiku
  extracted_url=$(jq -r '.env.ANTHROPIC_BASE_URL // empty' "$TARGET_SETTINGS_FILE" 2>/dev/null)
  extracted_model=$(jq -r '.env.ANTHROPIC_MODEL // empty' "$TARGET_SETTINGS_FILE" 2>/dev/null)
  extracted_opus=$(jq -r '.env.ANTHROPIC_DEFAULT_OPUS_MODEL // empty' "$TARGET_SETTINGS_FILE" 2>/dev/null)
  extracted_sonnet=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL // empty' "$TARGET_SETTINGS_FILE" 2>/dev/null)
  extracted_haiku=$(jq -r '.env.ANTHROPIC_DEFAULT_HAIKU_MODEL // empty' "$TARGET_SETTINGS_FILE" 2>/dev/null)
  
  if [[ -n "$extracted_url" ]]; then
    echo "   ğŸš€ API: $extracted_url"
  fi
  if [[ -n "$extracted_model" ]]; then
    echo "   ğŸ¤– é»˜è®¤æ¨¡å‹: $extracted_model"
  fi
  if [[ -n "$extracted_opus" ]]; then
    echo "   ğŸ§  Opus æ¨¡å‹: $extracted_opus"
  fi
  if [[ -n "$extracted_sonnet" ]]; then
    echo "   ğŸµ Sonnet æ¨¡å‹: $extracted_sonnet"
  fi
  if [[ -n "$extracted_haiku" ]]; then
    echo "   ğŸ‡ Haiku æ¨¡å‹: $extracted_haiku"
  fi
}

select_settings_file
