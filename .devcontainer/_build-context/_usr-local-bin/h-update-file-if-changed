#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

# Usage: echo "content" | h-update-file-if-changed <target_file> [chmod_mode] [description]

TARGET_FILE="${1:-}"
CHMOD_MODE="${2:-}"
DESCRIPTION="${3:-文件}"

if [[ -z "$TARGET_FILE" ]]; then
  echo "❌ 错误: h-update-file-if-changed 未指定目标文件。" >&2
  exit 1
fi

NEW_CONTENT=$(cat)
CURRENT_CONTENT=""

# Try to read current content
if [[ -f "$TARGET_FILE" ]]; then
  if [[ -r "$TARGET_FILE" ]]; then
    CURRENT_CONTENT=$(cat "$TARGET_FILE")
  elif sudo -n true 2>/dev/null; then
    CURRENT_CONTENT=$(sudo cat "$TARGET_FILE")
  else
    # If we can't read it, assume it's different or just try to write.
    # But for comparison we need content. If we can't read, we probably can't compare.
    echo "⚠️ 警告: 无法读取 $TARGET_FILE，将尝试直接写入。" >&2
  fi
fi

if [[ "$NEW_CONTENT" != "$CURRENT_CONTENT" ]]; then
  DIR_NAME=$(dirname "$TARGET_FILE")

  # Ensure directory exists
  if [[ ! -d "$DIR_NAME" ]]; then
    if [[ -w "$(dirname "$DIR_NAME")" ]]; then
      mkdir -p "$DIR_NAME"
    else
      sudo mkdir -p "$DIR_NAME"
    fi
  fi

  # Determine if we can write directly
  CAN_WRITE=false
  if [[ -e "$TARGET_FILE" ]]; then
     if [[ -w "$TARGET_FILE" ]]; then CAN_WRITE=true; fi
  else
     if [[ -w "$DIR_NAME" ]]; then CAN_WRITE=true; fi
  fi

  if $CAN_WRITE; then
    echo "$NEW_CONTENT" > "$TARGET_FILE"
  else
    echo "$NEW_CONTENT" | sudo tee "$TARGET_FILE" > /dev/null
  fi

  # Set permissions if specified
  if [[ -n "$CHMOD_MODE" ]]; then
    if [[ -w "$TARGET_FILE" ]]; then
      chmod "$CHMOD_MODE" "$TARGET_FILE"
    else
      sudo chmod "$CHMOD_MODE" "$TARGET_FILE"
    fi
  fi

  echo "⚙️  已更新${DESCRIPTION}: $TARGET_FILE"
else
  echo "⚙️  ${DESCRIPTION}无变化: $TARGET_FILE"
fi
