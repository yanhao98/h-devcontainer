#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

# 资料:
#   https://github.com/nodejs/docker-node
#   https://nodejs.org/dist/

NODE_VERSION="${NODE_VERSION:-24.12.0}"

# 确定架构
ARCH=
OPENSSL_ARCH=
dpkgArch="$(dpkg --print-architecture)"
case "${dpkgArch##*-}" in
    amd64) ARCH='x64'; OPENSSL_ARCH='linux-x86_64';;
    ppc64el) ARCH='ppc64le'; OPENSSL_ARCH='linux-ppc64le';;
    s390x) ARCH='s390x'; OPENSSL_ARCH='linux*-s390x';;
    arm64) ARCH='arm64'; OPENSSL_ARCH='linux-aarch64';;
    armhf) ARCH='armv7l'; OPENSSL_ARCH='linux-armv4';;
    i386) ARCH='x86'; OPENSSL_ARCH='linux-elf';;
    *) echo "错误: 不支持的架构: $dpkgArch"; exit 1 ;;
esac

# 缓存目录
sudo mkdir -p /vscode/node || true
sudo chown -R $(whoami):$(whoami) /vscode/node || true
cache_dir="/vscode/node"
tarball="node-v$NODE_VERSION-linux-$ARCH.tar.xz"
cached_file="$cache_dir/$tarball"

# 下载链接
node_dist_url="https://nodejs.org/dist/v$NODE_VERSION"
tarball_url="$node_dist_url/$tarball"
shasums_url="$node_dist_url/SHASUMS256.txt"

# 验证校验和函数
# 参数: $1=文件路径
verify_checksum() {
    local file="$1"
    local filename="$(basename "$file")"

    # 下载 SHASUMS256.txt 并查找对应文件的校验和
    echo "正在获取校验和..."
    local shasum_line
    shasum_line=$(_curl-fsSL "$shasums_url" | grep " $filename\$") || {
        echo "在 SHASUMS256.txt 中未找到 $filename"; return 1;
    }

    # 验证
    echo "$shasum_line" | (cd "$(dirname "$file")" && sha256sum -c -)
}

# 检查是否存在且校验通过
need_download=true
if [[ -f "$cached_file" ]]; then
    echo "发现已存在的 Node.js 归档文件 ($cached_file)，正在验证校验和..."
    if verify_checksum "$cached_file"; then
        echo "校验和验证成功，跳过下载。"
        need_download=false
    else
        echo "校验和不匹配或验证失败，将重新下载。"
        rm -f "$cached_file"
    fi
fi

if [[ "$need_download" == "true" ]]; then
    echo "正在下载 Node.js v$NODE_VERSION ($ARCH)..."
    _curl-fsSL -o "$cached_file" "$tarball_url" || {
        echo "下载失败: $tarball_url"; exit 1;
    }

    echo "正在验证下载的文件..."
    if ! verify_checksum "$cached_file"; then
        echo "下载的文件校验失败"; exit 1;
    fi
fi

# 安装
echo "正在安装 Node.js 到 /usr/local..."

# 检查 xz-utils
if ! command -v xz >/dev/null; then
    echo "正在安装 xz-utils..."
    sudo apt-get update && sudo apt-get install -y xz-utils
fi

# 使用 sudo 解压
sudo tar -xJf "$cached_file" -C /usr/local --strip-components=1 --no-same-owner

# 清理文档和无用文件
echo "正在清理无用文件..."
sudo rm -f /usr/local/README.md /usr/local/LICENSE /usr/local/CHANGELOG.md

# 清理 OpenSSL headers
if [[ -d "/usr/local/include/node/openssl/archs" ]]; then
    sudo find /usr/local/include/node/openssl/archs -mindepth 1 -maxdepth 1 ! -name "$OPENSSL_ARCH" -exec rm -rf {} \;
fi

# 创建兼容性软链接
if [[ ! -e "/usr/local/bin/nodejs" ]]; then
    sudo ln -s /usr/local/bin/node /usr/local/bin/nodejs
fi

# 验证安装
echo "✓ Node.js 安装成功："
echo "  node: $(node -v)"
echo "  npm: $(npm -v)"
