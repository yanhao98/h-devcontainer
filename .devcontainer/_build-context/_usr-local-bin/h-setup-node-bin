#!/usr/bin/env bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# èµ„æ–™:
#   https://github.com/nodejs/docker-node/blob/main/24/trixie-slim/Dockerfile
#   https://nodejs.org/dist/

if [[ -z "${NODE_VERSION:-}" || "${NODE_VERSION:-}" == "latest" ]]; then
    NODE_VERSION=$(_curl-fsSL--compressed https://nodejs.org/dist/index.json | jq -r '[.[] | select(.lts != false)][0].version' | tr -d 'v')
    # NODE_VERSION=$(_curl-fsSL--compressed https://nodejs.org/dist/index.tab | sed -n '2p' | awk '{print $1}' | tr -d 'v')
fi

# ç¡®å®šæ¶æ„
ARCH=
OPENSSL_ARCH=
dpkgArch="$(dpkg --print-architecture)"
case "${dpkgArch##*-}" in
    amd64) ARCH='x64'; OPENSSL_ARCH='linux-x86_64';;
    ppc64el) ARCH='ppc64le'; OPENSSL_ARCH='linux-ppc64le';;
    s390x) ARCH='s390x'; OPENSSL_ARCH='linux*-s390x';;
    arm64) ARCH='arm64'; OPENSSL_ARCH='linux-aarch64';;
    armhf) ARCH='armv7l'; OPENSSL_ARCH='linux-armv4';;
    i386) ARCH='x86'; OPENSSL_ARCH='linux-elf';;
    *) echo "âŒ é”™è¯¯: ä¸æ”¯æŒçš„æ¶æ„: $dpkgArch"; exit 1 ;;
esac

# ç»Ÿä¸€çš„ä¸‹è½½ç¼“å­˜ç›®å½•
sudo mkdir -p /vscode/downloads || true
sudo chown -R $(whoami):$(whoami) /vscode/downloads || true
cache_dir="/vscode/downloads"
tarball="node-v$NODE_VERSION-linux-$ARCH.tar.xz"
cached_file="$cache_dir/$tarball"

# ä¸‹è½½é“¾æ¥
node_dist_url="https://nodejs.org/dist/v$NODE_VERSION"
tarball_url="$node_dist_url/$tarball"
shasums_url="$node_dist_url/SHASUMS256.txt"

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸”æ ¡éªŒé€šè¿‡
need_download=true
if [[ -f "$cached_file" ]]; then
    echo "ğŸ“¦ å‘ç°å·²å­˜åœ¨çš„ Node.js å½’æ¡£æ–‡ä»¶ ($cached_file)ï¼Œæ­£åœ¨éªŒè¯æ ¡éªŒå’Œ..."
    if _verify_checksum "$cached_file" "$shasums_url"; then
        echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸï¼Œè·³è¿‡ä¸‹è½½ã€‚"
        need_download=false
    else
        echo "âš ï¸ æ ¡éªŒå’Œä¸åŒ¹é…æˆ–éªŒè¯å¤±è´¥ï¼Œå°†é‡æ–°ä¸‹è½½ã€‚"
        rm -f "$cached_file"
    fi
fi

if [[ "$need_download" == "true" ]]; then
    echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ Node.js v$NODE_VERSION ($ARCH)..."
    _curl-fsSL--compressed -o "$cached_file" "$tarball_url" || {
        echo "âŒ ä¸‹è½½å¤±è´¥: $tarball_url"; exit 1;
    }

    echo "ğŸ” æ­£åœ¨éªŒè¯ä¸‹è½½çš„æ–‡ä»¶..."
    if ! _verify_checksum "$cached_file" "$shasums_url"; then
        echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ ¡éªŒå¤±è´¥"; exit 1;
    fi
fi

# å®‰è£…
echo "ğŸ“¥ æ­£åœ¨å®‰è£… Node.js åˆ° /usr/local..."

# ä½¿ç”¨ sudo è§£å‹
sudo tar -xJf "$cached_file" -C /usr/local --strip-components=1 --no-same-owner

# æ¸…ç†æ–‡æ¡£å’Œæ— ç”¨æ–‡ä»¶
echo "ğŸ§¹ æ­£åœ¨æ¸…ç†æ— ç”¨æ–‡ä»¶..."
sudo rm -f /usr/local/README.md /usr/local/LICENSE /usr/local/CHANGELOG.md

# æ¸…ç† OpenSSL headers
if [[ -d "/usr/local/include/node/openssl/archs" ]]; then
    sudo find /usr/local/include/node/openssl/archs -mindepth 1 -maxdepth 1 ! -name "$OPENSSL_ARCH" -exec rm -rf {} \;
fi

# åˆ›å»ºå…¼å®¹æ€§è½¯é“¾æ¥
if [[ ! -e "/usr/local/bin/nodejs" ]]; then
    sudo ln -s /usr/local/bin/node /usr/local/bin/nodejs
fi

# éªŒè¯å®‰è£…
echo "âœ… Node.js å®‰è£…æˆåŠŸï¼š"
echo "   node: $(/usr/local/bin/node -v)"
echo "   npm: $(/usr/local/bin/npm -v)"
