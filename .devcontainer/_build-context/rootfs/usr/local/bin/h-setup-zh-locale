#!/usr/bin/env bash
set -o errexit    # 对应 -e
set -o nounset    # 对应 -u
set -o pipefail   # 对应 -o pipefail

# 防止在 locale 未生成时出现 perl 警告
export LC_ALL=C

sudoIf() {
  if [[ "$EUID" -ne 0 ]]; then
    sudo "$@"
  else
    "$@"
  fi
}

if ! dpkg --status locales >/dev/null 2>&1; then
  sudo _execute-remote-script https://Git.1-H.CC/Scripts/Linux/raw/branch/2026/devcontainer/apt-install-with-cache.sh \
    locales
fi

# 确保 locale 配置存在于 /etc/locale.gen
grep -q '^zh_CN.UTF-8 UTF-8' /etc/locale.gen || echo "zh_CN.UTF-8 UTF-8" | sudoIf tee -a /etc/locale.gen > /dev/null

# --keep-existing 会跳过已生成的 locale
sudoIf locale-gen --keep-existing

# 设置系统默认 locale（写入 /etc/default/locale）
sudoIf update-locale LANG=zh_CN.UTF-8
