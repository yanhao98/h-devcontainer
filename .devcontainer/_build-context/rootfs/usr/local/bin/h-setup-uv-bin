#!/usr/bin/env bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# èµ„æ–™:
#   https://docs.astral.sh/uv/getting-started/installation/
#   https://github.com/astral-sh/uv/releases
#   https://docs.astral.sh/uv/configuration/environment/

# ç¡®å®šæž¶æž„
arch="$(dpkg --print-architecture)"
case "${arch##*-}" in
    amd64) build="x86_64-unknown-linux-gnu";;
    arm64) build="aarch64-unknown-linux-gnu";;
    *) echo "âŒ é”™è¯¯: ä¸æ”¯æŒçš„æž¶æž„: $arch" >&2; exit 1 ;;
esac

asset_name="uv-${build}.tar.gz"

# ç»Ÿä¸€çš„ä¸‹è½½ç¼“å­˜ç›®å½•
sudo mkdir -p /vscode/downloads || true
sudo chown -R $(whoami):$(whoami) /vscode/downloads || true

# èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
if [[ -z "${UV_VERSION:-}" || "${UV_VERSION:-}" == "latest" ]]; then
    release_api_uri="https://api.github.com/repos/astral-sh/uv/releases/latest"
else
    release_api_uri="https://api.github.com/repos/astral-sh/uv/releases/tags/${UV_VERSION}"
fi

echo "ðŸ” æ­£åœ¨èŽ·å– uv ç‰ˆæœ¬ä¿¡æ¯..." >&2
release_info=$(_curl-fsSL--compressed "$release_api_uri")
version=$(echo "$release_info" | jq -r ".tag_name")
uv_uri=$(echo "$release_info" | jq -r ".assets[] | select(.name == \"$asset_name\") | .browser_download_url")
shasums_uri=$(echo "$release_info" | jq -r ".assets[] | select(.name == \"uv-${build}.tar.gz.sha256\") | .browser_download_url")

if [[ -z "$version" || "$version" == "null" || -z "$uv_uri" || "$uv_uri" == "null" || -z "$shasums_uri" || "$shasums_uri" == "null" ]]; then
    echo "âŒ é”™è¯¯: æ— æ³•ä»Ž GitHub API èŽ·å– uv çš„å‘å¸ƒä¿¡æ¯ã€‚" >&2
    echo "API URI: $release_api_uri" >&2
    exit 1
fi

echo "ðŸ“¦ æ‰¾åˆ° uv ${version} ($build)" >&2

# ç¼“å­˜è·¯å¾„ï¼ˆåŒ…å«ç‰ˆæœ¬å·ï¼‰
cached_tarball="/vscode/downloads/${asset_name%.tar.gz}-${version}.tar.gz"

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸”æ ¡éªŒé€šè¿‡
need_download=true
if [[ -f "$cached_tarball" ]]; then
    echo "ðŸ“¦ å‘çŽ°å·²å­˜åœ¨çš„ uv å½’æ¡£æ–‡ä»¶ ($cached_tarball)ï¼Œæ­£åœ¨éªŒè¯æ ¡éªŒå’Œ..." >&2

    # ä¸‹è½½ sha256 æ–‡ä»¶èŽ·å–æœŸæœ›çš„æ ¡éªŒå’Œ
    expected_checksum=$(_curl-fsSL--compressed "$shasums_uri" | awk '{print $1}')
    if _verify_checksum "$cached_tarball" "$expected_checksum" >&2; then
        echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸï¼Œè·³è¿‡ä¸‹è½½ã€‚" >&2
        need_download=false
    else
        echo "âš ï¸  æ ¡éªŒå’Œä¸åŒ¹é…æˆ–éªŒè¯å¤±è´¥ï¼Œå°†é‡æ–°ä¸‹è½½ã€‚" >&2
    fi
fi

if [[ "$need_download" == "true" ]]; then
    echo "â¬‡ï¸  æ­£åœ¨ä¸‹è½½ uv ${version} ($build)..." >&2
    _curl-fsSL--compressed -o "$cached_tarball" "$uv_uri" || {
        echo "âŒ ä¸‹è½½å¤±è´¥: $uv_uri" >&2; exit 1;
    }

    echo "ðŸ” æ­£åœ¨éªŒè¯ä¸‹è½½çš„æ–‡ä»¶..." >&2
    expected_checksum=$(_curl-fsSL--compressed "$shasums_uri" | awk '{print $1}')
    if ! _verify_checksum "$cached_tarball" "$expected_checksum" >&2; then
        echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ ¡éªŒå¤±è´¥" >&2; exit 1;
    fi
    echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸã€‚" >&2
fi

# å®‰è£…
echo "ðŸ“¥ æ­£åœ¨å®‰è£… uv åˆ° /usr/local/bin..." >&2

# è§£åŽ‹åˆ°ä¸´æ—¶ç›®å½•
tmp_dir="$(mktemp -d)" || { echo "âŒ åˆ›å»ºä¸´æ—¶ç›®å½•å¤±è´¥" >&2; exit 1; }
trap "rm -rf '$tmp_dir'" EXIT INT TERM HUP

tar -xzf "$cached_tarball" -C "$tmp_dir" --strip-components=1

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
sudo cp "$tmp_dir/uv" /usr/local/bin/uv
sudo cp "$tmp_dir/uvx" /usr/local/bin/uvx
sudo chmod +x /usr/local/bin/uv /usr/local/bin/uvx

# é…ç½® uv ç¼“å­˜ç›®å½•ï¼ˆå¯é€‰ï¼Œä½¿ç”¨æŒä¹…åŒ–ç›®å½•ï¼‰
if [[ -d "/vscode" ]]; then
    mkdir -p /vscode/uv-cache || true
    export UV_CACHE_DIR="/vscode/uv-cache"
fi

# å®‰è£… shell è¡¥å…¨
cmd_uv="/usr/local/bin/uv"
completion_file="$HOME/completion-for-uv.zsh"
$cmd_uv generate-shell-completion zsh > "$completion_file" || true

if [[ -f "$completion_file" && -s "$completion_file" ]]; then
    if ! grep -q 'source ~/completion-for-uv.zsh' ~/.zshrc 2>/dev/null; then
        echo 'source ~/completion-for-uv.zsh' >> ~/.zshrc
        echo "â˜‘ï¸  å·²æ·»åŠ  uv è‡ªåŠ¨è¡¥å…¨åˆ° ~/.zshrc" >&2
    else
        echo "â­ï¸  uv è‡ªåŠ¨è¡¥å…¨å·²å­˜åœ¨äºŽ ~/.zshrc ä¸­" >&2
    fi
fi

# é…ç½® UV_CACHE_DIR çŽ¯å¢ƒå˜é‡
if [[ -d "/vscode" ]]; then
    if ! grep -q 'export UV_CACHE_DIR=' ~/.zshrc 2>/dev/null; then
        echo 'export UV_CACHE_DIR="/vscode/uv-cache"' >> ~/.zshrc
        echo "â˜‘ï¸  å·²é…ç½® UV_CACHE_DIR åˆ° /vscode/uv-cache" >&2
    fi
fi

# éªŒè¯å®‰è£…
echo "âœ… uv å®‰è£…æˆåŠŸï¼š$($cmd_uv --version) (/usr/local/bin/uv)" >&2
