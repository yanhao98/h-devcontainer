#!/usr/bin/env bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# èµ„æ–™:
#   https://github.com/astral-sh/uv
#   https://docs.astral.sh/uv/getting-started/installation/

# ç¡®å®šæ¶æ„
arch="$(dpkg --print-architecture)"
case "${arch##*-}" in \
	amd64) build="x86_64-unknown-linux-gnu";; \
	arm64) build="aarch64-unknown-linux-gnu";; \
	*) echo "âŒ é”™è¯¯: ä¸æ”¯æŒçš„æ¶æ„: $arch" >&2; exit 1 ;; \
esac

# ç»Ÿä¸€çš„ä¸‹è½½ç¼“å­˜ç›®å½•
sudo mkdir -p /vscode/downloads || true
sudo chown -R $(whoami):$(whoami) /vscode/downloads || true

# è·å–ç‰ˆæœ¬ä¿¡æ¯
if [[ -z "${UV_VERSION:-}" || "${UV_VERSION:-}" == "latest" ]]; then
    release_api_uri="https://api.github.com/repos/astral-sh/uv/releases/latest"
    echo "ğŸ” æ­£åœ¨è·å– uv ç‰ˆæœ¬ä¿¡æ¯..." >&2
    release_info=$(_curl-fsSL--compressed "$release_api_uri")
    version=$(echo "$release_info" | jq -r ".tag_name")
else
    version="${UV_VERSION}"
fi

if [[ -z "$version" ]]; then
    echo "âŒ é”™è¯¯: æ— æ³•è·å– uv ç‰ˆæœ¬ä¿¡æ¯ã€‚" >&2
    exit 1
fi

asset_name="uv-${build}.tar.gz"
uv_uri="https://github.com/astral-sh/uv/releases/download/${version}/${asset_name}"
shasums_uri="${uv_uri}.sha256"

# ç¼“å­˜è·¯å¾„ï¼ˆåŒ…å«ç‰ˆæœ¬å·ï¼‰
cached_uv_path="/vscode/downloads/uv-${version}-${build}.tar.gz"

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸”æ ¡éªŒé€šè¿‡
need_download=true
if [[ -f "$cached_uv_path" ]]; then
    echo "ğŸ“¦ å‘ç°å·²å­˜åœ¨çš„ uv æ–‡ä»¶ ($cached_uv_path)ï¼Œæ­£åœ¨éªŒè¯æ ¡éªŒå’Œ..." >&2

    # æŒ‡å®š upstream_filename ä¸º generic åç§°
    if _verify_checksum "$cached_uv_path" "$shasums_uri" "${asset_name}"; then
        echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸï¼Œè·³è¿‡ä¸‹è½½ã€‚" >&2
        need_download=false
    else
        echo "âš ï¸  æ ¡éªŒå’Œä¸åŒ¹é…æˆ–éªŒè¯å¤±è´¥ï¼Œå°†é‡æ–°ä¸‹è½½ã€‚" >&2
    fi
fi

if [[ "$need_download" == "true" ]]; then
    echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ uv ${version} ($build)..." >&2
    _curl-fsSL--compressed -o "$cached_uv_path" "$uv_uri" || {
        echo "âŒ ä¸‹è½½å¤±è´¥: $uv_uri" >&2; exit 1;
    }

    echo "ğŸ” æ­£åœ¨éªŒè¯ä¸‹è½½çš„æ–‡ä»¶..." >&2
    # æŒ‡å®š upstream_filename ä¸º generic åç§°
    if ! _verify_checksum "$cached_uv_path" "$shasums_uri" "${asset_name}"; then
        echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ ¡éªŒå¤±è´¥" >&2; exit 1;
    fi
    echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸã€‚" >&2
fi

# å®‰è£…
echo "ğŸ“¥ æ­£åœ¨å®‰è£… uv åˆ° /usr/local/bin..." >&2

# è§£å‹å¹¶å®‰è£…
tmp_dir="$(mktemp -d)" || { echo "âŒ åˆ›å»ºä¸´æ—¶ç›®å½•å¤±è´¥" >&2; exit 1; }
trap "rm -rf '$tmp_dir'" EXIT INT TERM HUP

tar -xzf "$cached_uv_path" -C "$tmp_dir"

# uv çš„ tarball ç»“æ„é€šå¸¸æ˜¯ uv-x86_64-unknown-linux-gnu/uv
# æˆ‘ä»¬éœ€è¦æ‰¾åˆ° uv å’Œ uvx äºŒè¿›åˆ¶æ–‡ä»¶
find "$tmp_dir" -name "uv" -type f -exec sudo cp {} /usr/local/bin/ \;
find "$tmp_dir" -name "uvx" -type f -exec sudo cp {} /usr/local/bin/ \;

sudo chmod +x /usr/local/bin/uv
if [[ -f /usr/local/bin/uvx ]]; then
    sudo chmod +x /usr/local/bin/uvx
fi

# å®‰è£… shell è¡¥å…¨
# uv generate-shell-completion <shell>
if command -v uv &> /dev/null; then
    if [[ -w "$HOME/.zshrc" ]]; then
         # ç”Ÿæˆ zsh è¡¥å…¨æ–‡ä»¶
        echo "âš™ï¸  æ­£åœ¨ç”Ÿæˆ zsh è¡¥å…¨..." >&2
        uv generate-shell-completion zsh > "$HOME/.uv-completion.zsh"
        if ! grep -q 'source $HOME/.uv-completion.zsh' "$HOME/.zshrc"; then
            echo 'source $HOME/.uv-completion.zsh' >> "$HOME/.zshrc"
        fi
    fi

    if [[ -w "$HOME/.bashrc" ]]; then
         # ç”Ÿæˆ bash è¡¥å…¨æ–‡ä»¶
        echo "âš™ï¸  æ­£åœ¨ç”Ÿæˆ bash è¡¥å…¨..." >&2
        uv generate-shell-completion bash > "$HOME/.uv-completion.bash"
        if ! grep -q 'source $HOME/.uv-completion.bash' "$HOME/.bashrc"; then
             echo 'source $HOME/.uv-completion.bash' >> "$HOME/.bashrc"
        fi
    fi
fi

# éªŒè¯å®‰è£…
echo "âœ… uv å®‰è£…æˆåŠŸï¼š" >&2
echo "   uv: $(/usr/local/bin/uv --version)" >&2
if [[ -f /usr/local/bin/uvx ]]; then
    echo "   uvx: $(/usr/local/bin/uvx --version)" >&2
fi
