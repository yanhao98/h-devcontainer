#!/usr/bin/env bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# èµ„æ–™:
#   https://bun.com/install
#   https://bun.sh/docs/runtime/nodejs-compat
#   https://github.com/oven-sh/bun/blob/277fc558e2039e3ab25ecebecc5a3f04c5c3199a/dockerhub/debian-slim/Dockerfile

# ç¡®å®šæž¶æž„
arch="$(dpkg --print-architecture)"
case "${arch##*-}" in \
	amd64) build="x64-baseline";; \
	arm64) build="aarch64";; \
	*) echo "âŒ é”™è¯¯: ä¸æ”¯æŒçš„æž¶æž„: $arch" >&2; exit 1 ;; \
esac

# ç»Ÿä¸€çš„ä¸‹è½½ç¼“å­˜ç›®å½•
sudo mkdir -p /vscode/downloads || true
sudo chown -R $(whoami):$(whoami) /vscode/downloads || true
zip="/vscode/downloads/bun-linux-$build.zip"

# ä¸‹è½½é“¾æŽ¥
bun_uri="https://github.com/oven-sh/bun/releases/latest/download/bun-linux-$build.zip"
shasums_uri="https://github.com/oven-sh/bun/releases/latest/download/SHASUMS256.txt"

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸”æ ¡éªŒé€šè¿‡
need_download=true
if [[ -f "$zip" ]]; then
    echo "ðŸ“¦ å‘çŽ°å·²å­˜åœ¨çš„ Bun å½’æ¡£æ–‡ä»¶ï¼Œæ­£åœ¨éªŒè¯æ ¡éªŒå’Œ..." >&2

    if _verify_checksum "$zip" "$shasums_uri" 2>/dev/null; then
        echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸï¼Œè·³è¿‡ä¸‹è½½ã€‚" >&2
        need_download=false
    else
        echo "âš ï¸  æ ¡éªŒå’Œä¸åŒ¹é…æˆ–éªŒè¯å¤±è´¥ï¼Œå°†é‡æ–°ä¸‹è½½ã€‚" >&2
    fi
fi

if [[ "$need_download" == "true" ]]; then
    echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ Bun ($build)..." >&2
    _curl-fsSL--compressed -o "$zip" "$bun_uri" || {
        echo "âŒ ä¸‹è½½å¤±è´¥: $bun_uri" >&2; exit 1;
    }

    echo "ðŸ” æ­£åœ¨éªŒè¯ä¸‹è½½çš„æ–‡ä»¶..." >&2
    if ! _verify_checksum "$zip" "$shasums_uri"; then
        echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ ¡éªŒå¤±è´¥" >&2; exit 1;
    fi
    echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸã€‚" >&2
fi

# å®‰è£…
echo "ðŸ“¥ æ­£åœ¨å®‰è£… Bun åˆ° $HOME/.bun..." >&2

install_dir="$HOME/.bun"
sudo mkdir -p "$install_dir" || true
# æœ‰å¯èƒ½è¿™ä¸ªç›®å½•æ˜¯ volume æŒ‚è½½è¿‡æ¥çš„ï¼Œæƒé™ä¼šæœ‰é—®é¢˜
sudo chown -R $(whoami):$(whoami) "$install_dir" || true
bin_dir=$install_dir/bin

# è§£åŽ‹: -o è¦†ç›– -q é™é»˜ -j å¿½ç•¥ç›®å½•ç»“æž„ -d ç›®æ ‡ç›®å½•
unzip -oqjd "$bin_dir" "$zip" "bun-linux-$build/bun" || {
    echo "âŒ è§£åŽ‹ bun å¤±è´¥" >&2; exit 1;
}

# å®‰è£… shell è¡¥å…¨ï¼ˆå¤±è´¥ä¸å½±å“ï¼‰
IS_BUN_AUTO_UPDATE=true SHELL=zsh bun completions &>/dev/null || :

# éªŒè¯å®‰è£…
echo "âœ… Bun å®‰è£…æˆåŠŸï¼š" >&2
echo "   bun: $($HOME/.bun/bin/bun --version)" >&2
