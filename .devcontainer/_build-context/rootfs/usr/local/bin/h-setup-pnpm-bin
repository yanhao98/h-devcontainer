#!/usr/bin/env bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# èµ„æ–™:
#   https://github.com/pnpm/get.pnpm.io/blob/main/install.sh
#   https://pnpm.io/installation#in-a-docker-container
#   https://github.dev/pnpm/pnpm/packages/plugin-commands-setup/src/setup.ts
#   https://pnpm.io/zh/settings#statedir
#   https://pnpm.io/zh/completion

cd ~

# ç¡®å®šæž¶æž„
arch="$(dpkg --print-architecture)"
case "${arch##*-}" in \
	amd64) build="x64";; \
	arm64) build="arm64";; \
	*) echo "âŒ é”™è¯¯: ä¸æ”¯æŒçš„æž¶æž„: $arch" >&2; exit 1 ;; \
esac

asset_name="pnpm-linux-${build}"

# ç»Ÿä¸€çš„ä¸‹è½½ç¼“å­˜ç›®å½•
sudo mkdir -p /vscode/downloads || true
sudo chown -R $(whoami):$(whoami) /vscode/downloads || true

# èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
if [[ -z "${PNPM_VERSION:-}" || "${PNPM_VERSION:-}" == "latest" ]]; then
    release_api_uri="https://api.github.com/repos/pnpm/pnpm/releases/latest"
else
    release_api_uri="https://api.github.com/repos/pnpm/pnpm/releases/tags/v${PNPM_VERSION}"
fi

echo "ðŸ” æ­£åœ¨èŽ·å– pnpm ç‰ˆæœ¬ä¿¡æ¯..." >&2
release_info=$(_curl-fsSL--compressed "$release_api_uri")
version=$(echo "$release_info" | jq -r ".tag_name")
pnpm_uri=$(echo "$release_info" | jq -r ".assets[] | select(.name == \"$asset_name\") | .browser_download_url")
expected_checksum=$(echo "$release_info" | jq -r ".assets[] | select(.name == \"$asset_name\") | .digest" | cut -d: -f2)

if [[ -z "$version" || -z "$pnpm_uri" || -z "$expected_checksum" ]]; then
    echo "âŒ é”™è¯¯: æ— æ³•ä»Ž GitHub API èŽ·å– pnpm çš„å‘å¸ƒä¿¡æ¯ã€‚" >&2
    echo "API URI: $release_api_uri" >&2
    exit 1
fi

# ç¼“å­˜è·¯å¾„ï¼ˆåŒ…å«ç‰ˆæœ¬å·ï¼‰
cached_pnpm_path="/vscode/downloads/${asset_name}-${version}"

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸”æ ¡éªŒé€šè¿‡
need_download=true
if [[ -f "$cached_pnpm_path" ]]; then
    echo "ðŸ“¦ å‘çŽ°å·²å­˜åœ¨çš„ pnpm æ–‡ä»¶ ($cached_pnpm_path)ï¼Œæ­£åœ¨éªŒè¯æ ¡éªŒå’Œ..." >&2

    if _verify_checksum "$cached_pnpm_path" "$expected_checksum"; then
        echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸï¼Œè·³è¿‡ä¸‹è½½ã€‚" >&2
        need_download=false
    else
        echo "âš ï¸  æ ¡éªŒå’Œä¸åŒ¹é…æˆ–éªŒè¯å¤±è´¥ï¼Œå°†é‡æ–°ä¸‹è½½ã€‚" >&2
    fi
fi

if [[ "$need_download" == "true" ]]; then
    echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ pnpm ${version} ($build)..." >&2
    _curl-fsSL--compressed -o "$cached_pnpm_path" "$pnpm_uri" || {
        echo "âŒ ä¸‹è½½å¤±è´¥: $pnpm_uri" >&2; exit 1;
    }

    echo "ðŸ” æ­£åœ¨éªŒè¯ä¸‹è½½çš„æ–‡ä»¶..." >&2
    if ! _verify_checksum "$cached_pnpm_path" "$expected_checksum"; then
        echo "âŒ ä¸‹è½½çš„æ–‡ä»¶æ ¡éªŒå¤±è´¥" >&2; exit 1;
    fi
    echo "âœ… æ ¡éªŒå’ŒéªŒè¯æˆåŠŸã€‚" >&2
fi

# å®‰è£…
echo "ðŸ“¥ æ­£åœ¨å®‰è£… pnpm..." >&2

PNPM_HOME="${PNPM_HOME:-$HOME/.pnpm}"
tmp_dir="$(mktemp -d)" || { echo "âŒ åˆ›å»ºä¸´æ—¶ç›®å½•å¤±è´¥" >&2; exit 1; }
trap "rm -rf '$tmp_dir'" EXIT INT TERM HUP

cp "$cached_pnpm_path" "$tmp_dir/pnpm"
chmod +x "$tmp_dir/pnpm"

ENV="$HOME/.zshrc" SHELL="$(which zsh)" "$tmp_dir/pnpm" setup || { echo "âŒ pnpm setup å¤±è´¥" >&2; exit 1; }

# é…ç½® store ç›®å½•
cmd_pnpm="$PNPM_HOME/pnpm"
$cmd_pnpm config set store-dir /vscode/pnpm/pnpm-store || { echo "âŒ pnpm config set store-dir å¤±è´¥" >&2; exit 1; }

# å®‰è£… shell è¡¥å…¨
$cmd_pnpm completion zsh > ~/completion-for-pnpm.zsh
if ! grep -q 'source ~/completion-for-pnpm.zsh' ~/.zshrc; then
    echo 'source ~/completion-for-pnpm.zsh' >> ~/.zshrc
    echo "â˜‘ï¸  å·²æ·»åŠ  pnpm è‡ªåŠ¨è¡¥å…¨åˆ° ~/.zshrc" >&2
else
    echo "â­ï¸  pnpm è‡ªåŠ¨è¡¥å…¨å·²å­˜åœ¨äºŽ ~/.zshrc ä¸­" >&2
fi

# éªŒè¯å®‰è£…
echo "âœ… pnpm å®‰è£…æˆåŠŸï¼š$($cmd_pnpm --version) ($PNPM_HOME/pnpm)" >&2
