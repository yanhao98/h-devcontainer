#!/usr/bin/env bash
set -o errexit    # 对应 -e
set -o nounset    # 对应 -u
set -o pipefail   # 对应 -o pipefail

# Usage: _ensure-vscode-symlink <vscode_path> <home_target>
# Example: _ensure-vscode-symlink /vscode/gh-home ~/.gh

VSCODE_PATH="${1:?错误: 未指定 /vscode 源路径}"
HOME_TARGET="${2:?错误: 未指定 HOME 目标路径}"

mkdir -p "$VSCODE_PATH"

if [ -L "$HOME_TARGET" ] && [ "$(readlink "$HOME_TARGET")" = "$VSCODE_PATH" ]; then
    :
else
    mkdir -p "$(dirname "$HOME_TARGET")"
    if [ -d "$HOME_TARGET" ]; then
        mv "$HOME_TARGET" "$HOME_TARGET.bak.$(date +%Y%m%d%H%M%S)"
    fi
    ln -sfn "$VSCODE_PATH" "$HOME_TARGET"
fi
