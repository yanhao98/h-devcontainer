#!/usr/bin/env bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# Usage: _ensure-vscode-symlink <vscode_path> <home_target>
# Example: _ensure-vscode-symlink /vscode/gh-home ~/.gh

VSCODE_PATH="${1:?é”™è¯¯: æœªæŒ‡å®š /vscode æºè·¯å¾„}"
HOME_TARGET="${2:?é”™è¯¯: æœªæŒ‡å®š HOME ç›®æ ‡è·¯å¾„}"

mkdir -p "$VSCODE_PATH"

if [ -L "$HOME_TARGET" ] && [ "$(readlink "$HOME_TARGET")" = "$VSCODE_PATH" ]; then
    echo "âœ… è½¯é“¾æŽ¥å·²å°±ç»ªï¼Œè·³è¿‡: $HOME_TARGET â†’ $VSCODE_PATH" >&2
else
    mkdir -p "$(dirname "$HOME_TARGET")"
    if [ -d "$HOME_TARGET" ]; then
        BACKUP_PATH="$HOME_TARGET.bak.$(date +%Y%m%d%H%M%S)"
        echo "ðŸ“¦ å¤‡ä»½çŽ°æœ‰ç›®å½•: $HOME_TARGET â†’ $BACKUP_PATH" >&2
        mv "$HOME_TARGET" "$BACKUP_PATH"
    fi
    ln -sfn "$VSCODE_PATH" "$HOME_TARGET"
    echo "ðŸ”— å·²åˆ›å»ºè½¯é“¾æŽ¥: $HOME_TARGET â†’ $VSCODE_PATH" >&2
fi
