#!/bin/bash
# https://code.claude.com/docs/zh-CN/statusline
# ä» stdin è¯»å– JSON è¾“å…¥
input=$(cat)

# å°† input å†™å…¥è°ƒè¯•æ–‡ä»¶
# if [ ! -d /vscode/claude-config/debug-statusline ]; then
#     mkdir -p /vscode/claude-config/debug-statusline/
# fi
# echo "$input" > "/vscode/claude-config/debug-statusline/$(date +%Y%m%d-%H%M%S).json"

# å®šä¹‰é¢œè‰²
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 1. æå–æ¨¡å‹åç§°
MODEL_DISPLAY=$(echo "$input" | jq -r '.model.display_name // "Claude"')

# 2. æå–å¹¶æ ¼å¼åŒ–å½“å‰ç›®å½• (ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•)
DIR_DISPLAY=$(echo "$input" | jq -r '
  .workspace as $ws |
  $ws.current_dir as $cwd |
  $ws.project_dir as $pdir |
  if ($cwd | startswith($pdir)) then
    ($pdir | split("/") | last) + ($cwd | .[($pdir | length):])
  else
    ($cwd | split("/") | last)
  end
')

# 3. æå–æˆæœ¬ä¿¡æ¯ (ä¿ç•™6ä½å°æ•°ï¼Œå§‹ç»ˆæ˜¾ç¤º)ï¼Œç¬¬äºŒè¡Œçš„å¼€å§‹ã€‚
COST_DISPLAY=$(echo "$input" | jq -r '
  "ğŸ’¸ $" + (((.cost.total_cost_usd // 0) * 1000000 | floor) / 1000000 | tostring)
')

# 4. æå–è€—æ—¶ä¿¡æ¯ (å§‹ç»ˆæ˜¾ç¤º)
TOTAL_DURATION_MS=$(echo "$input" | jq -r '.cost.total_duration_ms // 0')
TOTAL_API_DURATION_MS=$(echo "$input" | jq -r '.cost.total_api_duration_ms // 0')

# æ ¼å¼åŒ–è€—æ—¶: <1s æ˜¾ç¤º ms, 1-60s æ˜¾ç¤ºç§’, >=60s æ˜¾ç¤º XmYs
format_duration() {
    local ms=${1%.*}  # å–æ•´æ•°éƒ¨åˆ†
    ms=${ms:-0}
    if [ "$ms" -lt 1000 ]; then
        echo "${ms}ms"
    elif [ "$ms" -lt 60000 ]; then
        awk "BEGIN {printf \"%.1fs\", $ms / 1000}"
    else
        local total_s=$((ms / 1000))
        local m=$((total_s / 60))
        local s=$((total_s % 60))
        echo "${m}m${s}s"
    fi
}

DURATION_DISPLAY=" â±ï¸ $(format_duration "$TOTAL_DURATION_MS") (API:$(format_duration "$TOTAL_API_DURATION_MS"))"

# 5. è·å– Git åˆ†æ”¯ä¿¡æ¯
GIT_BRANCH=""
if command -v git >/dev/null 2>&1 && git rev-parse --git-dir > /dev/null 2>&1; then
    BRANCH=$(git branch --show-current 2>/dev/null)
    if [ -n "$BRANCH" ]; then
        GIT_BRANCH=" ğŸŒ¿ $BRANCH"
    fi
fi

# 6. æå–ä»£ç å˜æ›´è¡Œæ•° (å§‹ç»ˆæ˜¾ç¤º)
LINES_ADDED=$(echo "$input" | jq -r '.cost.total_lines_added // 0')
LINES_REMOVED=$(echo "$input" | jq -r '.cost.total_lines_removed // 0')

LINES_CHANGE_DISPLAY=" ${GREEN}+${LINES_ADDED}${NC} ${RED}-${LINES_REMOVED}${NC}"

# 7. æå– Token ä½¿ç”¨ä¿¡æ¯ (å§‹ç»ˆæ˜¾ç¤º)
TOTAL_INPUT_TOKENS=$(echo "$input" | jq -r '.context_window.total_input_tokens // 0')
TOTAL_OUTPUT_TOKENS=$(echo "$input" | jq -r '.context_window.total_output_tokens // 0')
CONTEXT_WINDOW_SIZE=$(echo "$input" | jq -r '.context_window.context_window_size // 0')

# å½“å‰ä½¿ç”¨é‡ (current_usage å¯èƒ½ä¸º null)
CURRENT_INPUT=$(echo "$input" | jq -r '.context_window.current_usage.input_tokens // 0')
CURRENT_OUTPUT=$(echo "$input" | jq -r '.context_window.current_usage.output_tokens // 0')
CACHE_CREATION=$(echo "$input" | jq -r '.context_window.current_usage.cache_creation_input_tokens // 0')
CACHE_READ=$(echo "$input" | jq -r '.context_window.current_usage.cache_read_input_tokens // 0')

# æ ¼å¼åŒ– Token æ˜¾ç¤º (å§‹ç»ˆæ˜¾ç¤º)
# è®¡ç®—ä¸Šä¸‹æ–‡ä½¿ç”¨ç™¾åˆ†æ¯” (ä½¿ç”¨å½“å‰è¾“å…¥è€Œéç´¯è®¡æ€»é‡)
if [ "$CONTEXT_WINDOW_SIZE" -gt 0 ]; then
    USAGE_PERCENT=$((CURRENT_INPUT * 100 / CONTEXT_WINDOW_SIZE))
    # æ ¼å¼: å½“å‰/çª—å£å¤§å° (ç™¾åˆ†æ¯”) | ç´¯è®¡è¾“å…¥ ğŸ“¤ç´¯è®¡è¾“å‡º
    TOKEN_DISPLAY=" ğŸ“Š ${CURRENT_INPUT}/${CONTEXT_WINDOW_SIZE} (${USAGE_PERCENT}%) | Î£in:${TOTAL_INPUT_TOKENS} ğŸ“¤out:${TOTAL_OUTPUT_TOKENS}"
else
    TOKEN_DISPLAY=" ğŸ“Š â¬‡ï¸${CURRENT_INPUT} | Î£in:${TOTAL_INPUT_TOKENS} ğŸ“¤out:${TOTAL_OUTPUT_TOKENS}"
fi

# æ·»åŠ ç¼“å­˜æ˜¾ç¤º (å§‹ç»ˆæ˜¾ç¤º)
TOKEN_DISPLAY="${TOKEN_DISPLAY} ğŸ’¾read:${CACHE_READ}"

# æ•°æ®é‡è¿‡å°æ—¶ä¸è¾“å‡ºï¼ˆé¿å…æ— æ„ä¹‰çš„çŠ¶æ€è¡Œï¼‰
if [ "$TOTAL_API_DURATION_MS" -lt 10 ] || [ "$TOTAL_INPUT_TOKENS" -lt 100 ] || [ "$TOTAL_OUTPUT_TOKENS" -lt 100 ]; then
    exit 0
fi

# è¾“å‡ºæ ¼å¼åŒ–åçš„çŠ¶æ€è¡Œ
echo -e "${BLUE}[$MODEL_DISPLAY]${NC} ğŸ“ ${DIR_DISPLAY}${YELLOW}${GIT_BRANCH}\n${NC}${GREEN}${COST_DISPLAY}${NC}${DURATION_DISPLAY}${LINES_CHANGE_DISPLAY}${TOKEN_DISPLAY}"