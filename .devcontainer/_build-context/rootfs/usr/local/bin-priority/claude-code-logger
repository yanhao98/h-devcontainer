#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail
#-------------------------------------------------------------------------------------------------------------
# https://github.com/badlogic/lemmy/tree/main/apps/claude-trace
#-------------------------------------------------------------------------------------------------------------

if [ ! -d "/vscode/claude-code-logger" ]; then
    git clone https://github.com/yanhao98/claude-code-logger.git /vscode/claude-code-logger
fi

if [ ! -d "/vscode/claude-code-logger/node_modules" ]; then
    echo "ðŸ“¦ Installing dependencies for claude-code-logger..." >&2
    (cd /vscode/claude-code-logger && bun install)
fi

add-bun-priority-bin-pkg tsx@latest

# https://github.com/dreampulse/claude-code-logger?tab=readme-ov-file#-usage-examples
# Usage: claude-code-logger start [options]

# Start the proxy server

# Options:
#   -p, --port <port>         Local port to listen on (default: 8000)
#   -h, --host <host>         Remote host address (default: "api.anthropic.com")
#   -r, --remote-port <port>  Remote port (default: 443)
#   --https                   Use HTTPS for remote connection (default: true)
#   --local-https             Accept HTTPS connections locally (default: false)
#   --log-body                Log request and response bodies (default: false)
#   --merge-sse               Merge Server-Sent Events into readable messages (default: false)
#   --debug                   Show debug messages for troubleshooting (default: false)
#   --chat-mode               Show only chat conversation with live streaming (default: true)
#   -v, --verbose             Show full prompts without truncation (default: false)
#   --help                    display help for command


# å®šä¹‰å¯é€‰å‚æ•°
declare -A OPTIONS=(
    ["--debug"]="      Show debug messages for troubleshooting"
    ["--log-body"]="   Log request and response bodies"
    ["--merge-sse"]="  Merge Server-Sent Events into readable messages"
    ["--chat-mode"]="  Show only chat conversation with live streaming"
    ["--verbose"]="    Show full prompts without truncation"
    ["--local-https"]="Accept HTTPS connections locally"
    ["[LOG-FILE]"]="   Save output to log file (claude-session-YYYYMMDD-HHMMSS.log)"
)

# é€‰é¡¹é¡ºåº
OPTION_KEYS=("--debug" "--log-body" "--merge-sse" "--chat-mode" "--verbose" "--local-https" "[LOG-FILE]")

# ä»Žé…ç½®æ–‡ä»¶è¯»å–é»˜è®¤ host
DEFAULT_HOST=""
SETTINGS_FILE="/vscode/claude-config/settings.json"
if [[ -f "$SETTINGS_FILE" ]]; then
    # ä½¿ç”¨ jq æˆ– node è§£æž JSONï¼Œæå– env.ANTHROPIC_BASE_URL
    if command -v jq &> /dev/null; then
        DEFAULT_HOST=$(jq -r '.env.ANTHROPIC_BASE_URL // empty' "$SETTINGS_FILE" 2>/dev/null || true)
    elif command -v node &> /dev/null; then
        DEFAULT_HOST=$(node -e "try { const s = require('$SETTINGS_FILE'); console.log(s.env?.ANTHROPIC_BASE_URL || ''); } catch(e) {}" 2>/dev/null || true)
    fi
    # ä»Ž URL ä¸­æå– host éƒ¨åˆ† (åŽ»æŽ‰ http:// æˆ– https:// å‰ç¼€)
    if [[ -n "$DEFAULT_HOST" ]]; then
        DEFAULT_HOST=$(echo "$DEFAULT_HOST" | sed -E 's|^https?://||; s|/.*$||')
    fi
fi

# è§£æžå‘½ä»¤è¡Œå‚æ•°èŽ·å– --host
HOST_VALUE=""
REMAINING_ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--host)
            if [[ -n "${2:-}" ]]; then
                HOST_VALUE="$2"
                shift 2
            else
                echo "âŒ é”™è¯¯: --host å‚æ•°éœ€è¦ä¸€ä¸ªå€¼" >&2
                exit 1
            fi
            ;;
        *)
            REMAINING_ARGS+=("$1")
            shift
            ;;
    esac
done
set -- "${REMAINING_ARGS[@]}"

# å¦‚æžœå‘½ä»¤è¡Œæ²¡æœ‰æä¾› --hostï¼Œåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å€¼æˆ–äº¤äº’å¼è¾“å…¥
if [[ -z "$HOST_VALUE" ]]; then
    if [[ -n "$DEFAULT_HOST" ]]; then
        HOST_VALUE="$DEFAULT_HOST"
        echo "ðŸ“‹ ä»Žé…ç½®æ–‡ä»¶è¯»å– Remote host: $HOST_VALUE"
        echo ""
    else
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           claude-code-logger å¯åŠ¨é…ç½®                        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        read -rp "è¯·è¾“å…¥ Remote host åœ°å€ (--host): " HOST_VALUE
        if [[ -z "$HOST_VALUE" ]]; then
            echo "âŒ é”™è¯¯: --host å‚æ•°ä¸èƒ½ä¸ºç©º" >&2
            exit 1
        fi
        echo ""
    fi
fi

# é»˜è®¤é€‰ä¸­çš„é€‰é¡¹
declare -A SELECTED=(
    ["--debug"]=1
    ["--chat-mode"]=1
    ["--log-body"]=1
    ["[LOG-FILE]"]=1
    ["--verbose"]=1
    ["--merge-sse"]=1
)

# æ˜¾ç¤ºèœå•å‡½æ•°
show_menu() {
    clear
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           claude-code-logger å¯åŠ¨é€‰é¡¹é…ç½®                    â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘  ä½¿ç”¨æ•°å­—é”®åˆ‡æ¢é€‰é¡¹ï¼ŒæŒ‰ Enter ç¡®è®¤å¯åŠ¨ï¼ŒæŒ‰ q é€€å‡º            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  Remote host: $HOST_VALUE"
    echo ""
    
    local i=1
    for key in "${OPTION_KEYS[@]}"; do
        if [[ ${SELECTED[$key]:-0} -eq 1 ]]; then
            echo "  [$i] [âœ“] $key - ${OPTIONS[$key]}"
        else
            echo "  [$i] [ ] $key - ${OPTIONS[$key]}"
        fi
        ((i++))
    done
    echo ""
    echo "  [Enter] ç¡®è®¤å¯åŠ¨  |  [q] é€€å‡º"
    echo ""
}

# äº¤äº’å¼é€‰æ‹©
while true; do
    show_menu
    read -rsn1 input
    
    case "$input" in
        [1-7])
            idx=$((input - 1))
            key="${OPTION_KEYS[$idx]}"
            if [[ ${SELECTED[$key]:-0} -eq 1 ]]; then
                SELECTED[$key]=0
            else
                SELECTED[$key]=1
            fi
            ;;
        ""|$'\n')
            clear
            break
            ;;
        q|Q)
            echo "å·²å–æ¶ˆ"
            exit 0
            ;;
    esac
done

# ç”Ÿæˆ CLI_ARGS
CLI_ARGS=()
CLI_ARGS+=("start")
CLI_ARGS+=("--host" "$HOST_VALUE")

ENABLE_LOG_FILE=0
for key in "${OPTION_KEYS[@]}"; do
    if [[ ${SELECTED[$key]:-0} -eq 1 ]]; then
        if [[ "$key" == "[LOG-FILE]" ]]; then
            ENABLE_LOG_FILE=1
        else
            CLI_ARGS+=("$key")
        fi
    fi
done

echo ""

# å®šä¹‰ tsx å‘½ä»¤
TSX_CMD="/vscode/bun-priority-bin/node_modules/.bin/tsx"

echo -e "\e[90mâ†’ exec $TSX_CMD /vscode/claude-code-logger/src/cli.ts ${CLI_ARGS[*]} $*\e[0m" >&2

LOG_DIR="/vscode/claude-config/claude-code-logger"
mkdir -p "$LOG_DIR"

# å†™å…¥é…ç½®æ–‡ä»¶
cat > "$LOG_DIR/.settings.8000.json" << 'EOF'
{
  "env": {
    "ANTHROPIC_BASE_URL": "http://localhost:8000"
  }
}
EOF

# ç¡®å®š claude å‘½ä»¤çš„è·¯å¾„ï¼ˆä¸Žå½“å‰è„šæœ¬åœ¨åŒä¸€ç›®å½•ï¼‰
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -x "$SCRIPT_DIR/claude" ]]; then
    CLAUDE_CMD="$SCRIPT_DIR/claude"
elif [[ -x "/usr/local/bin-priority/claude" ]]; then
    CLAUDE_CMD="/usr/local/bin-priority/claude"
else
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° claude å‘½ä»¤" >&2
    exit 1
fi

# å¯åŠ¨ claude-code-logger åœ¨åŽå°
if [[ $ENABLE_LOG_FILE -eq 1 ]]; then
    SESSION_NAME="claude-session-$(date +%Y%m%d-%H%M%S)"
    SESSION_DIR="$LOG_DIR/$SESSION_NAME"
    mkdir -p "$SESSION_DIR"
    LOG_FILE="$SESSION_DIR/$SESSION_NAME.log"
    JSON_LOG_DIR="$SESSION_DIR"
    echo "ðŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_FILE" >&2
    echo "ðŸ“ JSON æ—¥å¿—ç›®å½•: $JSON_LOG_DIR" >&2
    CLAUDE_CODE_LOGGER_DIR="$JSON_LOG_DIR" $TSX_CMD /vscode/claude-code-logger/src/cli.ts "${CLI_ARGS[@]}" "$@" > "$LOG_FILE" 2>&1 &
else
    $TSX_CMD /vscode/claude-code-logger/src/cli.ts "${CLI_ARGS[@]}" "$@" &
fi
LOGGER_PID=$!

# ç­‰å¾… claude-code-logger å¯åŠ¨
sleep 1

# æ£€æŸ¥ claude-code-logger æ˜¯å¦æˆåŠŸå¯åŠ¨
if ! kill -0 $LOGGER_PID 2>/dev/null; then
    echo "âŒ é”™è¯¯: claude-code-logger å¯åŠ¨å¤±è´¥" >&2
    tail -n 20 "$LOG_FILE"
    exit 1
fi

echo "âœ… claude-code-logger å·²å¯åŠ¨ (PID: $LOGGER_PID)" >&2
echo -e "\e[90mâ†’ exec claude...\e[0m" >&2
echo ""

# è®¾ç½®æ¸…ç†å‡½æ•°ï¼Œç¡®ä¿é€€å‡ºæ—¶å…³é—­ claude-code-logger
cleanup() {
    if kill -0 $LOGGER_PID 2>/dev/null; then
        echo ""
        echo "ðŸ›‘ æ­£åœ¨å…³é—­ claude-code-logger (PID: $LOGGER_PID)..." >&2
        kill $LOGGER_PID 2>/dev/null || true
        wait $LOGGER_PID 2>/dev/null || true
    fi
}
trap cleanup EXIT

# è¿è¡Œ claudeï¼Œä½¿ç”¨ä»£ç†é…ç½®
"$CLAUDE_CMD" --settings "$LOG_DIR/.settings.8000.json"
CLAUDE_EXIT_CODE=$?

echo ""
if [[ $ENABLE_LOG_FILE -eq 1 ]]; then
    echo "ðŸ‘‹ claude å·²é€€å‡º (é€€å‡ºç : $CLAUDE_EXIT_CODE)" >&2
    echo "ðŸ“ æ—¥å¿—æ–‡ä»¶: $LOG_FILE" >&2
else
    echo "ðŸ‘‹ claude å·²é€€å‡º (é€€å‡ºç : $CLAUDE_EXIT_CODE)" >&2
fi

exit $CLAUDE_EXIT_CODE
