#!/bin/bash
set -o errexit    # 对应 -e
set -o nounset    # 对应 -u
set -o pipefail   # 对应 -o pipefail

add-bun-priority-bin-pkg @iflow-ai/iflow-cli@latest

BUN_ARGS=("--bun")
BUN_ARGS+=("run")
BUN_ARGS+=("/vscode/bun-priority-bin/node_modules/.bin/iflow")

# 检测是否运行不支持默认标志的子命令
IS_SUBCOMMAND=0
for arg in "$@"; do
    if [[ "$arg" == "mcp" ]] || [[ "$arg" == "commands" ]] || [[ "$arg" == "agent" ]] || [[ "$arg" == "workflow" ]] || [[ "$arg" == "skill" ]]; then
        IS_SUBCOMMAND=1
        break
    fi
    # 如果遇到非标志参数且不是子命令，则视为查询
    if [[ "$arg" != -* ]]; then
        break
    fi
done

CLI_ARGS=()
if [ "$IS_SUBCOMMAND" -eq 0 ]; then
    CLI_ARGS+=("--yolo")
    CLI_ARGS+=("--show-memory-usage")
fi

mkdir -p /vscode/iflow-home
# 检查软链接是否已正确建立，如果是则跳过
if [ -L "$HOME/.iflow" ] && [ "$(readlink "$HOME/.iflow")" = "/vscode/iflow-home" ]; then
    : # 软链接已正确建立，跳过
else
    if [ -d "$HOME/.iflow" ]; then
        rm -rf "$HOME/.iflow"
    fi
    ln -sfn /vscode/iflow-home ~/.iflow
fi

echo -e "\e[90m→ exec bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*\e[0m" >&2
# bun --bun --cwd=/vscode/bun-priority-bin/ run iflow --version

exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
