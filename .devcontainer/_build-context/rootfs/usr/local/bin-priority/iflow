#!/bin/bash
set -o errexit    # 对应 -e
set -o nounset    # 对应 -u
set -o pipefail   # 对应 -o pipefail

add-bun-priority-bin-pkg @iflow-ai/iflow-cli@latest

BUN_ARGS=("--bun")
BUN_ARGS+=("run")
BUN_ARGS+=("/vscode/bun-priority-bin/node_modules/.bin/iflow")

CLI_ARGS=()
CLI_ARGS+=("--yolo")
CLI_ARGS+=("--show-memory-usage")

mkdir -p /vscode/iflow-home
# 检查软链接是否已正确建立，如果是则跳过
if [ -L "$HOME/.iflow" ] && [ "$(readlink "$HOME/.iflow")" = "/vscode/iflow-home" ]; then
    : # 软链接已正确建立，跳过
else
    if [ -d "$HOME/.iflow" ]; then
        rm -rf "$HOME/.iflow"
    fi
    ln -sfn /vscode/iflow-home ~/.iflow
fi

echo -e "\e[90m→ exec bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*\e[0m"
# bun --bun --cwd=/vscode/bun-priority-bin/ run iflow --version

# 从 PATH 中移除当前脚本所在的目录，防止无限递归
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# 同时移除 /usr/local/bin-priority，因为这是安装后的位置
export PATH=$(echo "$PATH" | sed "s|$SCRIPT_DIR||g; s|/usr/local/bin-priority||g; s|::|:|g; s|^:||; s|:$||")

exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
