#!/bin/bash
set -o errexit    # 对应 -e
set -o nounset    # 对应 -u
set -o pipefail   # 对应 -o pipefail
#-------------------------------------------------------------------------------------------------------------
if false; then
# 示例：
hyperfine --warmup 10 --min-runs 50 \
  '/usr/local/bin/node /vscode/bun-priority-bin/node_modules/.bin/claude -v' \
  '/home/usr_vscode/.bun/bin/bun --bun run /vscode/bun-priority-bin/node_modules/.bin/claude -v'

hyperfine --warmup 10 --min-runs 50 \
  '/usr/local/bin/node /vscode/bun-priority-bin/node_modules/.bin/codex --version' \
  '/home/usr_vscode/.bun/bin/bun --bun run /vscode/bun-priority-bin/node_modules/.bin/codex --version'
fi

hyperfine --warmup 20 --min-runs 100 \
  '/usr/local/bin/node -e "console.log(\"hello\")" > /dev/null' \
  '/home/usr_vscode/.bun/bin/bun -e "console.log(\"hello\")" > /dev/null'

#-------------------------------------------------------------------------------------------------------------

if ! dpkg --status hyperfine &>/dev/null; then
  # 创建临时 apt 配置，启用锁等待（-1 表示无限等待）
  APT_WAIT_CONF=$(mktemp)
  echo 'DPkg::Lock::Timeout "-1";' > "$APT_WAIT_CONF"
  export APT_CONFIG="$APT_WAIT_CONF"
  
  # -E 选项：保留（preserve）当前的环境变量
  sudo -E _execute-remote-script https://Git.1-H.CC/Scripts/Linux/raw/branch/2026/devcontainer/apt-install-with-cache.sh \
    hyperfine
  
  rm -f "$APT_WAIT_CONF"
fi

# 跳过自身，找到真实的 hyperfine 可执行文件
real_hyperfine=$(which -a hyperfine | grep -v '/usr/local/bin-priority/' | head -n1)
exec "$real_hyperfine" "$@"