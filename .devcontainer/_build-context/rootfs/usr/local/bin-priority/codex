#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

source /devcontainer/shim-utils.sh
_print_caller_info

# ç¡®ä¿é»˜è®¤é…ç½®æ–‡ä»¶å­˜åœ¨
ensure_default_config() {
    # Dockerfile: CODEX_HOME=/vscode/codex-home
    local config_dir="/vscode/codex-home"
    local config_file="$config_dir/config.toml"
    
    mkdir -p "$config_dir"
    
    if [ -f "$config_file" ]; then
        echo "ðŸ“ é…ç½®æ–‡ä»¶å·²å­˜åœ¨: $config_file" >&2
    else
        echo "ðŸ“ åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶: $config_file" >&2
        cat > "$config_file" << 'EOF'
model = "gemini-3-pro-preview"
model_provider = "NewAPI"
preferred_auth_method = "apikey"
# ç¦æ­¢å°† AI å“åº”å†™å…¥æœ¬åœ°å­˜å‚¨
# disable_response_storage = true

[model_providers.NewAPI]
name = "New API"
base_url = "https://new-api.example.com/v1"
wire_api = "chat"
http_headers = {"Authorization" = "Bearer your_api_key_here"}
EOF
    fi
}

add-bun-priority-bin-pkg @openai/codex@latest

# è°ƒç”¨å‡½æ•°ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
ensure_default_config

BUN_ARGS=("--bun")
BUN_ARGS+=("run")
BUN_ARGS+=("/vscode/bun-priority-bin/node_modules/.bin/codex")
CLI_ARGS=()
CLI_ARGS+=("--sandbox=danger-full-access")

echo -e "\e[90mâ†’ exec bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*\e[0m" >&2

_print_group_end

exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
