#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# https://github.com/anthropics/claude-code/blob/1fe9e369a7c30805189cbbb72eb69c15ed4ec96b/.devcontainer/Dockerfile#L42
# https://code.claude.com/docs/zh-CN/settings#å¯ç”¨è®¾ç½®
# https://code.claude.com/docs/zh-CN/settings#çŽ¯å¢ƒå˜é‡
# https://code.claude.com/docs/zh-CN/statusline

#-------------------------------------------------------------------------------------------------------------
# ANTHROPIC_AUTH_TOKEN
# ANTHROPIC_BASE_URL

# ç›´æŽ¥æŒ‡å®šå½“å‰ä½¿ç”¨çš„æ¨¡åž‹
# ANTHROPIC_MODEL

# ç”¨äºŽ haiku çš„æ¨¡åž‹ï¼Œæˆ–åŽå°åŠŸèƒ½
# ANTHROPIC_DEFAULT_HAIKU_MODEL=claude-haiku-4-5-20251001

# ç”¨äºŽ opus çš„æ¨¡åž‹ï¼Œæˆ–åœ¨è®¡åˆ’æ¨¡å¼æ´»è·ƒæ—¶ç”¨äºŽ opusplan çš„æ¨¡åž‹ã€‚
# ANTHROPIC_DEFAULT_OPUS_MODEL=claude-opus-4-5-20251101

# ç”¨äºŽ sonnet çš„æ¨¡åž‹ï¼Œæˆ–åœ¨è®¡åˆ’æ¨¡å¼ä¸æ´»è·ƒæ—¶ç”¨äºŽ opusplan çš„æ¨¡åž‹ã€‚
# ANTHROPIC_DEFAULT_SONNET_MODEL=claude-sonnet-4-5-20250929

# CLAUDE_CODE_SUBAGENT_MODEL	ç”¨äºŽå­ä»£ç†çš„æ¨¡åž‹

# "apiKeyHelper": "/bin/generate_temp_api_key.sh",
#-------------------------------------------------------------------------------------------------------------

source /devcontainer/shim-utils.sh
_print_caller_info
echo "ðŸš€ æ­£åœ¨è¿è¡Œ Claude Code åŒ…è£…å™¨ ($0)" >&2

add-bun-priority-bin-pkg @anthropic-ai/claude-code@latest

_ensure-vscode-symlink /vscode/claude-config/ ~/.claude
ln -sfn  ~/.claude/.claude.json ~/.claude.json


# åˆå§‹åŒ– Claude Code é…ç½®æ–‡ä»¶
init_claude_config() {
  local config_file="/vscode/claude-config/.claude.json"
  local updated=0
  
  mkdir -p "$(dirname "$config_file")"
  
  # å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©º JSON å¯¹è±¡
  if [[ ! -f "$config_file" ]]; then
    echo '{}' > "$config_file"
    updated=1
  fi
  
  # è¯»å–å½“å‰é…ç½®
  local current_config
  current_config=$(cat "$config_file")
  
  # æ£€æŸ¥å¹¶è®¾ç½® numStartups
  if ! echo "$current_config" | jq -e 'has("numStartups")' > /dev/null 2>&1; then
    current_config=$(echo "$current_config" | jq '.numStartups = 0')
    updated=1
  fi
  
  # æ£€æŸ¥å¹¶è®¾ç½® theme
  if ! echo "$current_config" | jq -e 'has("theme")' > /dev/null 2>&1; then
    current_config=$(echo "$current_config" | jq '.theme = "light-daltonized"')
    updated=1
  fi
  
  # æ£€æŸ¥å¹¶è®¾ç½® bypassPermissionsModeAccepted
  if ! echo "$current_config" | jq -e 'has("bypassPermissionsModeAccepted")' > /dev/null 2>&1; then
    current_config=$(echo "$current_config" | jq '.bypassPermissionsModeAccepted = true')
    updated=1
  fi
  
  # æ£€æŸ¥å¹¶è®¾ç½® hasCompletedOnboarding
  if ! echo "$current_config" | jq -e 'has("hasCompletedOnboarding")' > /dev/null 2>&1; then
    current_config=$(echo "$current_config" | jq '.hasCompletedOnboarding = true')
    updated=1
  fi
  
  # å¦‚æžœæœ‰æ›´æ–°ï¼Œå†™å…¥æ–‡ä»¶
  if [[ $updated -eq 1 ]]; then
    echo "$current_config" > "$config_file"
    echo "âš™ï¸  å·²åˆå§‹åŒ–é…ç½®æ–‡ä»¶: $config_file" >&2
  fi
}

# èŽ·å– claude-statusline è„šæœ¬çš„è·¯å¾„
get_statusline_path() {
  local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -x "$script_dir/claude-statusline" ]]; then
    echo "$script_dir/claude-statusline"
  elif command -v claude-statusline &>/dev/null; then
    command -v claude-statusline
  else
    echo "claude-statusline"
  fi
}

# èŽ·å– claude-switch-settings è„šæœ¬çš„è·¯å¾„
get_switch_settings_path() {
  local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -x "$script_dir/claude-switch-settings" ]]; then
    echo "$script_dir/claude-switch-settings"
  elif command -v claude-switch-settings &>/dev/null; then
    command -v claude-switch-settings
  fi
}

# è®¾ç½® Claude Code çš„æ‰˜ç®¡é…ç½®
setup_managed_settings() {
  local announcements=()
  local target_settings_file="/vscode/claude-config/settings.json"

  if [[ -f "$target_settings_file" ]]; then
    local extracted_url
    local extracted_model
    local extracted_opus_model
    local extracted_sonnet_model
    local extracted_haiku_model
    
    extracted_url=$(jq -r '.env.ANTHROPIC_BASE_URL // empty' "$target_settings_file" 2>/dev/null)
    extracted_model=$(jq -r '.env.ANTHROPIC_MODEL // empty' "$target_settings_file" 2>/dev/null)
    extracted_opus_model=$(jq -r '.env.ANTHROPIC_DEFAULT_OPUS_MODEL // empty' "$target_settings_file" 2>/dev/null)
    extracted_sonnet_model=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL // empty' "$target_settings_file" 2>/dev/null)
    extracted_haiku_model=$(jq -r '.env.ANTHROPIC_DEFAULT_HAIKU_MODEL // empty' "$target_settings_file" 2>/dev/null)
    
    if [[ -n "$extracted_url" ]]; then
      announcements+=("ðŸš€         API: $extracted_url")
    fi
    if [[ -n "$extracted_model" ]]; then
      announcements+=("ðŸ¤–    é»˜è®¤æ¨¡åž‹: $extracted_model")
    fi
    if [[ -n "$extracted_opus_model" ]]; then
      announcements+=("ðŸ§    Opus æ¨¡åž‹: $extracted_opus_model")
    fi
    if [[ -n "$extracted_sonnet_model" ]]; then
      announcements+=("ðŸŽµ Sonnet æ¨¡åž‹: $extracted_sonnet_model")
    fi
    if [[ -n "$extracted_haiku_model" ]]; then
      announcements+=("ðŸ‡  Haiku æ¨¡åž‹: $extracted_haiku_model")
    fi
  fi

  if [[ -n "${SELECTED_SETTINGS_FILE:-}" ]]; then
      announcements+=("ðŸ“„ $(basename "$SELECTED_SETTINGS_FILE")")
  fi

  # å¦‚æžœæ²¡æœ‰ä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·
  if [[ ${#announcements[@]} -eq 0 ]]; then
    announcements+=("âš ï¸ æœªæ‰¾åˆ°é…ç½®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ settings æ–‡ä»¶ã€‚")
  fi

  # åˆå¹¶æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨ \n åˆ†éš”
  # æŸ¥æ‰¾ claude-switch-settings è„šæœ¬çš„å®žé™…è·¯å¾„
  local switch_script_path
  switch_script_path="$(get_switch_settings_path)"

  # å¦‚æžœ switch_script_path ä»¥å½“å‰å·¥ä½œç›®å½•å¼€å¤´ï¼Œåˆ™ç§»é™¤è¯¥å‰ç¼€
  if [[ "$switch_script_path" == "$PWD"* ]]; then
    switch_script_path="${switch_script_path#$PWD/}"
  fi
  
  local combined_announcement=""
  local separator="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  if [[ -n "$switch_script_path" ]]; then
    combined_announcement="ðŸ’¡ åˆ‡æ¢é…ç½®: $switch_script_path\n$separator"
  else
    combined_announcement="ðŸ’¡ åˆ‡æ¢é…ç½®: claude-switch-settings\n$separator"
  fi
  for item in "${announcements[@]}"; do
    combined_announcement="${combined_announcement}\n${item}"
  done
  
  # è½¬ä¹‰åŒå¼•å·
  combined_announcement="${combined_announcement//\"/\\\"}"

  # èŽ·å– claude-statusline çš„å®žé™…è·¯å¾„
  local statusline_path
  statusline_path="$(get_statusline_path)"

  local settings_json='{
  "companyAnnouncements": ["'"$combined_announcement"'"],
  "defaultMode": "bypassPermissions",
  "statusLine": {
    "type": "command",
    "command": "'"$statusline_path"'",
    "padding": 0
  }
}'
  
  local target_file="/etc/claude-code/managed-settings.json"
  echo "$settings_json" | _update-file-if-changed "$target_file" 666 "æ‰˜ç®¡é…ç½®"
}

init_claude_config
setup_managed_settings


# BUN_ARGS=("--bun")
# BUN_ARGS+=("run")
# BUN_ARGS+=("/vscode/bun-priority-bin/node_modules/.bin/claude")
TARGET_BIN="/vscode/bun-priority-bin/node_modules/.bin/claude"

CLI_ARGS=("--dangerously-skip-permissions")

echo -e "\e[90mâ†’ exec bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*\e[0m" >&2
# bun --bun --cwd=/vscode/bun-priority-bin/ run claude --version

_print_group_end

export CLAUDE_CODE_ATTRIBUTION_HEADER=0 # https://linux.do/t/topic/1508040/13

export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
# export CLAUDE_CONFIG_DIR=/vscode/claude-config
export CLAUDE_CODE_TMPDIR=/vscode/claude-tmp
exec "${TARGET_BIN}" "${CLI_ARGS[@]}" "$@"
