#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

mkdir -p /vscode/bun-priority-bin/
bun --no-progress --cwd=/vscode/bun-priority-bin/ add @iflow-ai/iflow-cli@latest

BUN_ARGS=("--bun")
BUN_ARGS+=("--cwd=/vscode/bun-priority-bin/")
BUN_ARGS+=("run")
BUN_ARGS+=("iflow")

CLI_ARGS=()

mkdir -p /vscode/iflow-home
if [ -d "$HOME/.iflow" ]; then
    rm -rf "$HOME/.iflow"
fi

ln -sfn /vscode/iflow-home ~/.iflow

echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ: bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*"
# bun --bun --cwd=/vscode/bun-priority-bin/ run iflow --version

# ä» PATH ä¸­ç§»é™¤å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œé˜²æ­¢æ— é™é€’å½’
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# åŒæ—¶ç§»é™¤ /usr/local/bin-priorityï¼Œå› ä¸ºè¿™æ˜¯å®‰è£…åçš„ä½ç½®
export PATH=$(echo "$PATH" | sed "s|$SCRIPT_DIR||g; s|/usr/local/bin-priority||g; s|::|:|g; s|^:||; s|:$||")

exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
