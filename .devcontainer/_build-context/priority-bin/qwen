#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

mkdir -p /vscode/bun-priority-bin/
bun --no-progress --cwd=/vscode/bun-priority-bin/ add @qwen-code/qwen-code@latest

BUN_ARGS=("--bun")
BUN_ARGS+=("run")
BUN_ARGS+=("/vscode/bun-priority-bin/node_modules/.bin/qwen")
CLI_ARGS=()
CLI_ARGS+=("--yolo")
# CLI_ARGS+=("--show-memory-usage")
CLI_ARGS+=("--experimental-skills")

mkdir -p /vscode/qwen-home
# æ£€æŸ¥è½¯é“¾æ¥æ˜¯å¦å·²æ­£ç¡®å»ºç«‹ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡
if [ -L "$HOME/.qwen" ] && [ "$(readlink "$HOME/.qwen")" = "/vscode/qwen-home" ]; then
    : # è½¯é“¾æ¥å·²æ­£ç¡®å»ºç«‹ï¼Œè·³è¿‡
else
    if [ -d "$HOME/.qwen" ]; then
        rm -rf "$HOME/.qwen"
    fi
    ln -sfn /vscode/qwen-home ~/.qwen
fi

echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ: bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*"
# bun --bun --cwd=/vscode/bun-priority-bin/ run iflow --version

# ä» PATH ä¸­ç§»é™¤å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œé˜²æ­¢æ— é™é€’å½’
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# åŒæ—¶ç§»é™¤ /usr/local/bin-priorityï¼Œå› ä¸ºè¿™æ˜¯å®‰è£…åçš„ä½ç½®
export PATH=$(echo "$PATH" | sed "s|$SCRIPT_DIR||g; s|/usr/local/bin-priority||g; s|::|:|g; s|^:||; s|:$||")

exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
