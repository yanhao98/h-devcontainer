#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# ç¡®ä¿é»˜è®¤é…ç½®æ–‡ä»¶å­˜åœ¨
ensure_default_config() {
    local config_dir="/vscode/codex-home"
    local config_file="$config_dir/config.toml"
    local auth_file="$config_dir/auth.json"
    
    mkdir -p "$config_dir"
    
    if [ -f "$config_file" ]; then
        echo "ðŸ“ é…ç½®æ–‡ä»¶å·²å­˜åœ¨: $config_file"
    else
        echo "ðŸ“ åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶: $config_file"
        cat > "$config_file" << 'EOF'
model = "gemini-3-pro-preview"
model_provider = "NewAPI"
preferred_auth_method = "apikey"
# ç¦æ­¢å°† AI å“åº”å†™å…¥æœ¬åœ°å­˜å‚¨
# disable_response_storage = true

[model_providers.NewAPI]
name = "New API"
base_url = "https://new-api.example.com/v1"
wire_api = "chat"
EOF
    fi
    
    if [ -f "$auth_file" ]; then
        echo "ðŸ“ è®¤è¯æ–‡ä»¶å·²å­˜åœ¨: $auth_file"
    else
        echo "ðŸ“ åˆ›å»ºé»˜è®¤è®¤è¯æ–‡ä»¶: $auth_file"
        cat > "$auth_file" << 'EOF'
{
  "OPENAI_API_KEY": ""
}
EOF
    fi
}

mkdir -p /vscode/bun-priority-bin/
bun --no-progress --cwd=/vscode/bun-priority-bin/ add @openai/codex@latest

# è°ƒç”¨å‡½æ•°ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
ensure_default_config

BUN_ARGS=("--bun")
BUN_ARGS+=("run")
BUN_ARGS+=("/vscode/bun-priority-bin/node_modules/.bin/codex")
CLI_ARGS=()
CLI_ARGS+=("--sandbox=danger-full-access")

echo "ðŸš€ æ­£åœ¨æ‰§è¡Œ: bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*"
# bun --bun --cwd=/vscode/bun-priority-bin/ run codex --version

# ä»Ž PATH ä¸­ç§»é™¤å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œé˜²æ­¢æ— é™é€’å½’
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# åŒæ—¶ç§»é™¤ /usr/local/bin-priorityï¼Œå› ä¸ºè¿™æ˜¯å®‰è£…åŽçš„ä½ç½®
export PATH=$(echo "$PATH" | sed "s|$SCRIPT_DIR||g; s|/usr/local/bin-priority||g; s|::|:|g; s|^:||; s|:$||")

exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
