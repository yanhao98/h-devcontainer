#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail
# >>>>> Gemini CLI
# é™åˆ¶: bunx ä¸æ”¯æŒ --env-file å‚æ•°
# ç›¸å…³é—®é¢˜: https://github.com/oven-sh/bun/issues/12430

# gemini-cli çš„ GEMINI_DIR è·¯å¾„è¢«ç¡¬ç¼–ç ä¸º '.gemini'
# æºç å‚è€ƒ: https://github.com/google-gemini/gemini-cli/blob/bc168bbae4f4907f0518ba69964fffab670d84ec/packages/core/src/utils/paths.ts#L11

# è§£å†³æ–¹æ¡ˆ: åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º .env.local æ–‡ä»¶æ¥é…ç½® GOOGLE_GEMINI_BASE_URL å’Œ GEMINI_API_KEY
# ç¯å¢ƒå˜é‡æ–‡æ¡£: https://bun.com/docs/runtime/environment-variables#setting-environment-variables
# <<<<< Gemini CLI

mkdir -p /vscode/bun-priority-bin/
bun --no-progress --cwd=/vscode/bun-priority-bin/ add @google/gemini-cli@latest

BUN_ARGS=("--bun")
BUN_ARGS+=("--cwd=/vscode/bun-priority-bin/")
BUN_ARGS+=("run")
BUN_ARGS+=("gemini")
# BUN_ARGS+=("--env-file=<val>")
# /vscode/bun-priority-bin/.env.local

CLI_ARGS=("--yolo")
# CLI_ARGS+=("--model=gemini-1.5-flash")

mkdir -p /vscode/gemini-home
if [ -d "$HOME/.gemini" ]; then
    rm -rf "$HOME/.gemini"
fi

ln -sfn /vscode/gemini-home ~/.gemini


ensure_gemini_settings() {
  local content='{
  "security": { "auth": { "selectedType": "gemini-api-key" } },
  "ide": { "enabled": true },
  "general": { "previewFeatures": true }
}'

  if [[ -f /vscode/gemini-system-settings.json ]]; then
    echo "Gemini CLI é…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡è¦†ç›–ã€‚"
  else
    echo "$content" > /vscode/gemini-system-settings.json
  fi
}

ensure_gemini_settings

echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ: bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*"
# bun --bun --cwd=/vscode/bun-priority-bin/ run gemini --version

# ä» PATH ä¸­ç§»é™¤å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œé˜²æ­¢æ— é™é€’å½’
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# åŒæ—¶ç§»é™¤ /usr/local/bin-priorityï¼Œå› ä¸ºè¿™æ˜¯å®‰è£…åçš„ä½ç½®
export PATH=$(echo "$PATH" | sed "s|$SCRIPT_DIR||g; s|/usr/local/bin-priority||g; s|::|:|g; s|^:||; s|:$||")

export SANDBOX=h-devctr
export GEMINI_CLI_SYSTEM_SETTINGS_PATH=/vscode/gemini-system-settings.json
exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
