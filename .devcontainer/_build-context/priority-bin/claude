#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail

# https://github.com/anthropics/claude-code/blob/1fe9e369a7c30805189cbbb72eb69c15ed4ec96b/.devcontainer/Dockerfile#L42
# https://code.claude.com/docs/zh-CN/settings#å¯ç”¨è®¾ç½®
# https://code.claude.com/docs/zh-CN/statusline
echo "ğŸš€ æ­£åœ¨å¯åŠ¨ Claude Code åŒ…è£…å™¨ ($0)..."

# bun add -g @anthropic-ai/claude-code@latest
# bun remove -g @anthropic-ai/claude-code

claude="bunx"
# CLAUDE_ARGS=("--bun" "--package" "@anthropic-ai/claude-code@latest" "claude")
echo "ğŸ“¦ æ­£åœ¨æ£€æŸ¥å¹¶å®‰è£… @anthropic-ai/claude-code@latest..."
bun add -g @anthropic-ai/claude-code@latest > /dev/null 2>&1
CLAUDE_ARGS=("--no-install" "--bun" "-g" "claude")

CLAUDE_ARGS+=("--dangerously-skip-permissions")

# åˆå§‹åŒ– Claude Code é…ç½®æ–‡ä»¶
init_claude_config() {
  local config_file="/vscode/claude-config/.claude.json"
  local config_content='{
  "numStartups": 0,
  "theme": "light-daltonized",
  "bypassPermissionsModeAccepted": true,
  "hasCompletedOnboarding": true
}'

  if [[ -f "$config_file" ]]; then
    # echo "Claude Code é…ç½®æ–‡ä»¶ (.claude.json) å·²å­˜åœ¨ï¼Œè·³è¿‡è¦†ç›–ã€‚"
    :
  else
    mkdir -p "$(dirname "$config_file")"
    echo "$config_content" > "$config_file"
    echo "âš™ï¸  å·²åˆå§‹åŒ–é…ç½®æ–‡ä»¶: $config_file"
  fi
}

init_claude_config

# æ£€æµ‹å¹¶é€‰æ‹© settings æ–‡ä»¶
select_settings_file() {
  local settings_dir="/vscode/claude-config"
  local settings_files=()

  # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
  if [[ ! -d "$settings_dir" ]]; then
    echo "âš ï¸  è­¦å‘Š: ç›®å½• $settings_dir ä¸å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½ settings æ–‡ä»¶"
    return
  fi

  # æŸ¥æ‰¾æ‰€æœ‰ settings.*.json æ–‡ä»¶
  while IFS= read -r -d '' file; do
    settings_files+=("$file")
  done < <(find "$settings_dir" -maxdepth 1 -type f -name "settings.*.json" -print0 2>/dev/null)

  # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶
  if [[ ${#settings_files[@]} -eq 0 ]]; then
    echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ° settings.*.json æ–‡ä»¶ï¼Œè·³è¿‡åŠ è½½ settings æ–‡ä»¶"
    return
  fi

  # å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨
  if [[ ${#settings_files[@]} -eq 1 ]]; then
    echo "âœ… æ‰¾åˆ° settings æ–‡ä»¶: $(basename "${settings_files[0]}")"
    CLAUDE_ARGS+=("--settings=${settings_files[0]}")
    export SELECTED_SETTINGS_FILE="${settings_files[0]}"
    return
  fi

  # å¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œè®©ç”¨æˆ·é€‰æ‹©
  local selected_name
  local filenames=()
  for file in "${settings_files[@]}"; do
    filenames+=("$(basename "$file")")
  done

  # ä½¿ç”¨ fzf è¿›è¡Œé€‰æ‹©
  set +e # é¿å… fzf å–æ¶ˆæ—¶é€€å‡ºè„šæœ¬
  selected_name=$(printf "%s
" "${filenames[@]}" | fzf --prompt="è¯·é€‰æ‹© settings æ–‡ä»¶: " --height=10 --layout=reverse)
  set -e

  if [[ -n "$selected_name" ]]; then
    local selected_file="$settings_dir/$selected_name"
    echo "âœ… å·²é€‰æ‹©: $selected_name"
    CLAUDE_ARGS+=("--settings=$selected_file")
    export SELECTED_SETTINGS_FILE="$selected_file"
  else
    echo "âš ï¸ æœªé€‰æ‹© settings æ–‡ä»¶ï¼Œè·³è¿‡åŠ è½½"
  fi
}

select_settings_file

# è®¾ç½® Claude Code çš„æ‰˜ç®¡é…ç½®
setup_managed_settings() {
  local announcement="âœ¨ Welcome to Claude Code!"
  if [[ -n "${SELECTED_SETTINGS_FILE:-}" ]] && [[ -f "$SELECTED_SETTINGS_FILE" ]]; then
    local extracted_url
    extracted_url=$(jq -r '.env.ANTHROPIC_BASE_URL // empty' "$SELECTED_SETTINGS_FILE" 2>/dev/null)
    if [[ -n "$extracted_url" ]]; then
      announcement="ğŸš€ Base URL: $extracted_url"
    fi
  fi

  local settings_json='{
  "companyAnnouncements": ["'"$announcement"'"],
  "defaultMode": "bypassPermissions",
  "statusLine": {
    "type": "command",
    "command": "claude-statusline",
    "padding": 0
  }
}'
  
  sudo mkdir -p /etc/claude-code
  echo "$settings_json" | sudo tee /etc/claude-code/managed-settings.json > /dev/null
  sudo chmod 666 /etc/claude-code/managed-settings.json
  echo "âš™ï¸  å·²ç”Ÿæˆæ‰˜ç®¡é…ç½®: /etc/claude-code/managed-settings.json"
}

setup_managed_settings

# ANTHROPIC_AUTH_TOKEN
# ANTHROPIC_BASE_URL

# ç›´æ¥æŒ‡å®šå½“å‰ä½¿ç”¨çš„æ¨¡å‹
# ANTHROPIC_MODEL

# ç”¨äº haiku çš„æ¨¡å‹ï¼Œæˆ–åå°åŠŸèƒ½
# ANTHROPIC_DEFAULT_HAIKU_MODEL=claude-haiku-4-5-20251001

# ç”¨äº opus çš„æ¨¡å‹ï¼Œæˆ–åœ¨è®¡åˆ’æ¨¡å¼æ´»è·ƒæ—¶ç”¨äº opusplan çš„æ¨¡å‹ã€‚
# ANTHROPIC_DEFAULT_OPUS_MODEL=claude-opus-4-5-20251101

# ç”¨äº sonnet çš„æ¨¡å‹ï¼Œæˆ–åœ¨è®¡åˆ’æ¨¡å¼ä¸æ´»è·ƒæ—¶ç”¨äº opusplan çš„æ¨¡å‹ã€‚
# ANTHROPIC_DEFAULT_SONNET_MODEL=claude-sonnet-4-5-20250929

# CLAUDE_CODE_SUBAGENT_MODEL	ç”¨äºå­ä»£ç†çš„æ¨¡å‹

# "apiKeyHelper": "/bin/generate_temp_api_key.sh",


echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ: $claude ${CLAUDE_ARGS[*]} $*"

# ä» PATH ä¸­ç§»é™¤å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œé˜²æ­¢æ— é™é€’å½’
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# åŒæ—¶ç§»é™¤ /usr/local/bin-priorityï¼Œå› ä¸ºè¿™æ˜¯å®‰è£…åçš„ä½ç½®
export PATH=$(echo "$PATH" | sed "s|$SCRIPT_DIR||g; s|/usr/local/bin-priority||g; s|::|:|g; s|^:||; s|:$||")

exec "$claude" "${CLAUDE_ARGS[@]}" "$@"
