#!/bin/bash
set -o errexit    # å¯¹åº” -e
set -o nounset    # å¯¹åº” -u
set -o pipefail   # å¯¹åº” -o pipefail
# https://github.com/anthropics/claude-code/blob/1fe9e369a7c30805189cbbb72eb69c15ed4ec96b/.devcontainer/Dockerfile#L42
# https://code.claude.com/docs/zh-CN/settings#å¯ç”¨è®¾ç½®
# https://code.claude.com/docs/zh-CN/settings#ç¯å¢ƒå˜é‡
# https://code.claude.com/docs/zh-CN/statusline

#-------------------------------------------------------------------------------------------------------------
# ANTHROPIC_AUTH_TOKEN
# ANTHROPIC_BASE_URL

# ç›´æ¥æŒ‡å®šå½“å‰ä½¿ç”¨çš„æ¨¡å‹
# ANTHROPIC_MODEL

# ç”¨äº haiku çš„æ¨¡å‹ï¼Œæˆ–åå°åŠŸèƒ½
# ANTHROPIC_DEFAULT_HAIKU_MODEL=claude-haiku-4-5-20251001

# ç”¨äº opus çš„æ¨¡å‹ï¼Œæˆ–åœ¨è®¡åˆ’æ¨¡å¼æ´»è·ƒæ—¶ç”¨äº opusplan çš„æ¨¡å‹ã€‚
# ANTHROPIC_DEFAULT_OPUS_MODEL=claude-opus-4-5-20251101

# ç”¨äº sonnet çš„æ¨¡å‹ï¼Œæˆ–åœ¨è®¡åˆ’æ¨¡å¼ä¸æ´»è·ƒæ—¶ç”¨äº opusplan çš„æ¨¡å‹ã€‚
# ANTHROPIC_DEFAULT_SONNET_MODEL=claude-sonnet-4-5-20250929

# CLAUDE_CODE_SUBAGENT_MODEL	ç”¨äºå­ä»£ç†çš„æ¨¡å‹

# "apiKeyHelper": "/bin/generate_temp_api_key.sh",
#-------------------------------------------------------------------------------------------------------------


# è·å–å¹¶æ‰“å°è°ƒç”¨è€…ä¿¡æ¯
PARENT_INFO=$(ps -p $PPID -o args= 2>/dev/null || echo "unknown")
echo "ğŸ” è°ƒç”¨è€…: $PARENT_INFO (PID: $PPID)"

echo "ğŸš€ æ­£åœ¨å¯åŠ¨ Claude Code åŒ…è£…å™¨ ($0)..."

echo "ğŸ“¦ æ­£åœ¨æ£€æŸ¥å¹¶å®‰è£… @anthropic-ai/claude-code@latest..."
mkdir -p /vscode/bun-priority-bin/
bun --no-progress --cwd=/vscode/bun-priority-bin/ add @anthropic-ai/claude-code@latest


# åˆå§‹åŒ– Claude Code é…ç½®æ–‡ä»¶
init_claude_config() {
  local config_file="/vscode/claude-config/.claude.json"
  local config_content='{
  "numStartups": 0,
  "theme": "light-daltonized",
  "bypassPermissionsModeAccepted": true,
  "hasCompletedOnboarding": true
}'

  if [[ -f "$config_file" ]]; then
    # echo "Claude Code é…ç½®æ–‡ä»¶ (.claude.json) å·²å­˜åœ¨ï¼Œè·³è¿‡è¦†ç›–ã€‚"
    :
  else
    mkdir -p "$(dirname "$config_file")"
    echo "$config_content" > "$config_file"
    echo "âš™ï¸  å·²åˆå§‹åŒ–é…ç½®æ–‡ä»¶: $config_file"
  fi
}

# æ£€æµ‹å¹¶é€‰æ‹© settings æ–‡ä»¶
select_settings_file() {
  local settings_dir="/vscode/claude-config"
  local target_settings_file="/vscode/claude-config/settings.json"
  local settings_files=()

  # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
  if [[ ! -d "$settings_dir" ]]; then
    echo "âš ï¸  è­¦å‘Š: ç›®å½• $settings_dir ä¸å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½ settings æ–‡ä»¶"
    return
  fi

  # æŸ¥æ‰¾æ‰€æœ‰ settings.*.json æ–‡ä»¶
  while IFS= read -r -d '' file; do
    settings_files+=("$file")
  done < <(find "$settings_dir" -maxdepth 1 -type f -name "settings.*.json" -print0 | sort -z)

  # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶
  if [[ ${#settings_files[@]} -eq 0 ]]; then
    echo "âš ï¸  è­¦å‘Š: åœ¨ $settings_dir ä¸­æœªæ‰¾åˆ° settings.*.json æ–‡ä»¶ï¼Œè·³è¿‡åŠ è½½ settings æ–‡ä»¶"
    return
  fi

  local selected_file=""

  # å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨
  if [[ ${#settings_files[@]} -eq 1 ]]; then
    selected_file="${settings_files[0]}"
    echo "âœ… æ‰¾åˆ° settings æ–‡ä»¶: $selected_file"
  else
    # å¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œè®©ç”¨æˆ·é€‰æ‹©
    local selected_name
    local filenames=()
    for file in "${settings_files[@]}"; do
      filenames+=("$(basename "$file")")
    done

    # ä½¿ç”¨ fzf è¿›è¡Œé€‰æ‹©
    set +e # é¿å… fzf å–æ¶ˆæ—¶é€€å‡ºè„šæœ¬
    selected_name=$(printf "%s\n" "${filenames[@]}" | fzf --prompt="è¯·é€‰æ‹© settings æ–‡ä»¶: " --height=10 --layout=reverse)
    set -e

    if [[ -n "$selected_name" ]]; then
      selected_file="$settings_dir/$selected_name"
      echo "âœ… å·²é€‰æ‹©: $selected_file"
    else
      echo "âš ï¸ æœªé€‰æ‹© settings æ–‡ä»¶ï¼Œè·³è¿‡åŠ è½½"
      return
    fi
  fi

  if [[ -n "$selected_file" ]]; then
    export SELECTED_SETTINGS_FILE="$selected_file"
    
    # åˆå¹¶ settings æ–‡ä»¶åˆ° target_settings_file
    if [[ -f "$target_settings_file" ]]; then
      echo "ğŸ”„ æ­£åœ¨åˆå¹¶ settings åˆ° $target_settings_file ..."
      
      # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å… jq å¤±è´¥å¯¼è‡´åŸæ–‡ä»¶æŸå
      local temp_merged_file
      temp_merged_file=$(mktemp)

      # å°è¯•åˆå¹¶ã€‚å¦‚æœç›®æ ‡æ–‡ä»¶ä¸ºç©ºï¼Œå°†å…¶è§†ä¸º {}
      if [[ ! -s "$target_settings_file" ]]; then
        echo "{}" > "$target_settings_file"
      fi

      # å®šä¹‰éœ€è¦é‡ç½®çš„ç¯å¢ƒå˜é‡å­—æ®µï¼Œé˜²æ­¢æ—§é…ç½®æ®‹ç•™
      local reset_json='{
        "env": {
          "ANTHROPIC_AUTH_TOKEN": "",
          "ANTHROPIC_BASE_URL": "",
          "ANTHROPIC_MODEL": "",
          "ANTHROPIC_DEFAULT_HAIKU_MODEL": "",
          "ANTHROPIC_DEFAULT_OPUS_MODEL": "",
          "ANTHROPIC_DEFAULT_SONNET_MODEL": "",
          "CLAUDE_CODE_SUBAGENT_MODEL": ""
        }
      }'

      if jq -s --argjson reset "$reset_json" '.[0] * $reset * .[1]' "$target_settings_file" "$selected_file" > "$temp_merged_file"; then
        mv "$temp_merged_file" "$target_settings_file"
        chmod 666 "$target_settings_file" 2>/dev/null || true # å°è¯•ç¡®ä¿æƒé™æ­£ç¡®
        echo "âœ… Settings åˆå¹¶æˆåŠŸ"
      else
        echo "âš ï¸ Settings åˆå¹¶å¤±è´¥ (JSON æ ¼å¼é”™è¯¯?)ï¼Œå°†ç›´æ¥è¦†ç›–åŸæ–‡ä»¶"
        cp "$selected_file" "$target_settings_file"
        rm -f "$temp_merged_file"
      fi
    else
      echo "ğŸ“„ æ­£åœ¨å¤åˆ¶ settings åˆ° $target_settings_file ..."
      cp "$selected_file" "$target_settings_file"
    fi
  fi
}

# è®¾ç½® Claude Code çš„æ‰˜ç®¡é…ç½®
setup_managed_settings() {
  local announcements=()
  local target_settings_file="/vscode/claude-config/settings.json"

  if [[ -f "$target_settings_file" ]]; then
    local extracted_url
    local extracted_model
    
    extracted_url=$(jq -r '.env.ANTHROPIC_BASE_URL // empty' "$target_settings_file" 2>/dev/null)
    extracted_model=$(jq -r '.env.ANTHROPIC_MODEL // empty' "$target_settings_file" 2>/dev/null)
    
    if [[ -n "$extracted_url" ]]; then
      announcements+=("ğŸš€ $extracted_url")
    fi
    if [[ -n "$extracted_model" ]]; then
      announcements+=("ğŸ¤– $extracted_model")
    fi
  fi

  if [[ -n "${SELECTED_SETTINGS_FILE:-}" ]]; then
      announcements+=("ğŸ“„ $(basename "$SELECTED_SETTINGS_FILE")")
  fi

  # å¦‚æœæ²¡æœ‰ä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·
  if [[ ${#announcements[@]} -eq 0 ]]; then
    announcements+=("âš ï¸ æœªæ‰¾åˆ°é…ç½®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ settings æ–‡ä»¶ã€‚")
  fi

  # åˆå¹¶æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨ \n åˆ†éš”
  local combined_announcement=""
  for item in "${announcements[@]}"; do
    if [[ -n "$combined_announcement" ]]; then
      combined_announcement="${combined_announcement}\n${item}"
    else
      combined_announcement="${item}"
    fi
  done
  
  # è½¬ä¹‰åŒå¼•å·
  combined_announcement="${combined_announcement//\"/\\\"}"

  local settings_json='{
  "companyAnnouncements": ["'"$combined_announcement"'"],
  "defaultMode": "bypassPermissions",
  "statusLine": {
    "type": "command",
    "command": "claude-statusline",
    "padding": 0
  }
}'
  
  sudo mkdir -p /etc/claude-code
  echo "$settings_json" | sudo tee /etc/claude-code/managed-settings.json > /dev/null
  sudo chmod 666 /etc/claude-code/managed-settings.json
  echo "âš™ï¸  å·²ç”Ÿæˆæ‰˜ç®¡é…ç½®: /etc/claude-code/managed-settings.json"
}

init_claude_config
select_settings_file
setup_managed_settings


BUN_ARGS=("--bun")
BUN_ARGS+=("run")
BUN_ARGS+=("/vscode/bun-priority-bin/node_modules/.bin/claude")

CLI_ARGS=("--dangerously-skip-permissions")

echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ: bun ${BUN_ARGS[*]} ${CLI_ARGS[*]} $*"
# bun --bun --cwd=/vscode/bun-priority-bin/ run claude --version

# ä» PATH ä¸­ç§»é™¤å½“å‰è„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œé˜²æ­¢æ— é™é€’å½’
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# åŒæ—¶ç§»é™¤ /usr/local/bin-priorityï¼Œå› ä¸ºè¿™æ˜¯å®‰è£…åçš„ä½ç½®
export PATH=$(echo "$PATH" | sed "s|$SCRIPT_DIR||g; s|/usr/local/bin-priority||g; s|::|:|g; s|^:||; s|:$||")

exec bun "${BUN_ARGS[@]}" "${CLI_ARGS[@]}" "$@"
