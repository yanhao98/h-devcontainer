#!/bin/bash
# https://code.claude.com/docs/zh-CN/statusline
# ä» stdin è¯»å– JSON è¾“å…¥
input=$(cat)

# å°† input å†™å…¥è°ƒè¯•æ–‡ä»¶
# echo "$input" > "/vscode/claude-config/debug-statusline/$(date +%Y%m%d-%H%M%S).json"

# å®šä¹‰é¢œè‰²
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 1. æå–æ¨¡å‹åç§°
MODEL_DISPLAY=$(echo "$input" | jq -r '.model.display_name // "Claude"')

# 2. æå–å¹¶æ ¼å¼åŒ–å½“å‰ç›®å½• (ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•)
DIR_DISPLAY=$(echo "$input" | jq -r '
  .workspace as $ws |
  $ws.current_dir as $cwd |
  $ws.project_dir as $pdir |
  if ($cwd | startswith($pdir)) then
    ($pdir | split("/") | last) + ($cwd | .[($pdir | length):])
  else
    ($cwd | split("/") | last)
  end
')

# 3. æå–æˆæœ¬ä¿¡æ¯ (ä»…å½“å¤§äº0æ—¶æ˜¾ç¤ºï¼Œä¿ç•™6ä½å°æ•°)
COST_DISPLAY=$(echo "$input" | jq -r '
  if (.cost.total_cost_usd // 0) > 0 then
    " ğŸ’¸ $" + ((.cost.total_cost_usd * 1000000 | floor) / 1000000 | tostring)
  else
    ""
  end
')

# 4. æå–è€—æ—¶ä¿¡æ¯
TOTAL_DURATION_MS=$(echo "$input" | jq -r '.cost.total_duration_ms // 0')
TOTAL_API_DURATION_MS=$(echo "$input" | jq -r '.cost.total_api_duration_ms // 0')

DURATION_DISPLAY=""
if [ "$TOTAL_DURATION_MS" -gt 0 ]; then
    # è½¬æ¢ä¸ºç§’ï¼Œä¿ç•™1ä½å°æ•°
    TOTAL_DURATION_S=$(awk "BEGIN {printf \"%.1f\", $TOTAL_DURATION_MS / 1000}")
    API_DURATION_S=$(awk "BEGIN {printf \"%.1f\", $TOTAL_API_DURATION_MS / 1000}")
    DURATION_DISPLAY=" â±ï¸ ${TOTAL_DURATION_S}s (API:${API_DURATION_S}s)"
fi

# 5. è·å– Git åˆ†æ”¯ä¿¡æ¯
GIT_BRANCH=""
if command -v git >/dev/null 2>&1 && git rev-parse --git-dir > /dev/null 2>&1; then
    BRANCH=$(git branch --show-current 2>/dev/null)
    if [ -n "$BRANCH" ]; then
        GIT_BRANCH=" ğŸŒ¿ $BRANCH"
    fi
fi

# 6. æå–ä»£ç å˜æ›´è¡Œæ•°
LINES_ADDED=$(echo "$input" | jq -r '.cost.total_lines_added // 0')
LINES_REMOVED=$(echo "$input" | jq -r '.cost.total_lines_removed // 0')

LINES_CHANGE_DISPLAY=""
if [ "$LINES_ADDED" -gt 0 ]; then
    LINES_CHANGE_DISPLAY="${LINES_CHANGE_DISPLAY} ${GREEN}+${LINES_ADDED}${NC}"
fi
if [ "$LINES_REMOVED" -gt 0 ]; then
    LINES_CHANGE_DISPLAY="${LINES_CHANGE_DISPLAY} ${RED}-${LINES_REMOVED}${NC}"
fi

# 7. æå– Token ä½¿ç”¨ä¿¡æ¯ (åœ¨ context_window å­—æ®µä¸‹)
TOTAL_INPUT_TOKENS=$(echo "$input" | jq -r '.context_window.total_input_tokens // 0')
TOTAL_OUTPUT_TOKENS=$(echo "$input" | jq -r '.context_window.total_output_tokens // 0')
CONTEXT_WINDOW_SIZE=$(echo "$input" | jq -r '.context_window.context_window_size // 0')

# å½“å‰ä½¿ç”¨é‡ (current_usage å¯èƒ½ä¸º null)
CURRENT_INPUT=$(echo "$input" | jq -r '.context_window.current_usage.input_tokens // 0')
CURRENT_OUTPUT=$(echo "$input" | jq -r '.context_window.current_usage.output_tokens // 0')
CACHE_CREATION=$(echo "$input" | jq -r '.context_window.current_usage.cache_creation_input_tokens // 0')
CACHE_READ=$(echo "$input" | jq -r '.context_window.current_usage.cache_read_input_tokens // 0')

# æ ¼å¼åŒ– Token æ˜¾ç¤º
TOKEN_DISPLAY=""
if [ "$TOTAL_INPUT_TOKENS" -gt 0 ] || [ "$TOTAL_OUTPUT_TOKENS" -gt 0 ]; then
    # è®¡ç®—ä¸Šä¸‹æ–‡ä½¿ç”¨ç™¾åˆ†æ¯”
    if [ "$CONTEXT_WINDOW_SIZE" -gt 0 ]; then
        USAGE_PERCENT=$((TOTAL_INPUT_TOKENS * 100 / CONTEXT_WINDOW_SIZE))
        TOKEN_DISPLAY=" ğŸ“Š ${TOTAL_INPUT_TOKENS}/${CONTEXT_WINDOW_SIZE} (${USAGE_PERCENT}%) â¬†ï¸ ${TOTAL_OUTPUT_TOKENS}"
    else
        TOKEN_DISPLAY=" ğŸ“Š â¬‡ï¸${TOTAL_INPUT_TOKENS} â¬†ï¸${TOTAL_OUTPUT_TOKENS}"
    fi
    
    # å¦‚æœæœ‰ç¼“å­˜ä¿¡æ¯ï¼Œæ·»åŠ ç¼“å­˜æ˜¾ç¤º
    if [ "$CACHE_READ" -gt 0 ] || [ "$CACHE_CREATION" -gt 0 ]; then
        TOKEN_DISPLAY="${TOKEN_DISPLAY} ğŸ’¾${CACHE_READ}"
    fi
fi

# è¾“å‡ºæ ¼å¼åŒ–åçš„çŠ¶æ€è¡Œ
echo -e "${BLUE}[$MODEL_DISPLAY]${NC} ğŸ“ ${DIR_DISPLAY}${YELLOW}${GIT_BRANCH}${NC}${GREEN}${COST_DISPLAY}${NC}${DURATION_DISPLAY}${LINES_CHANGE_DISPLAY}${TOKEN_DISPLAY}"
