#!/bin/zsh
set -euo pipefail

# >>>>> Claude Code 工具
# 参考: https://github.com/anthropics/claude-code/blob/1fe9e369a7c30805189cbbb72eb69c15ed4ec96b/.devcontainer/Dockerfile#L42
bun add -g @anthropic-ai/claude-code@latest

if ! grep -q ">>>>> Claude Code" ~/.zshrc; then
cat <<'EOF' >> ~/.zshrc

# >>>>> Claude Code
alias claude='bunx --bun -g claude --dangerously-skip-permissions'
export DEVCONTAINER=true
export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
export DISABLE_TELEMETRY=1
export CLAUDE_CONFIG_DIR=/vscode/claude-config
# <<<<< Claude Code
EOF
fi

mkdir -p /vscode/claude-config

local CLAUDE_JSON_CONTENT='{
  "numStartups": 1,
  "theme": "light-daltonized",
  "bypassPermissionsModeAccepted": true,
  "hasCompletedOnboarding": true
}'

local SETTINGS_JSON_CONTENT='{
  "model": "opus",
  "alwaysThinkingEnabled": false,
  "defaultMode": "bypassPermissions"
}'

# >>>>> Claude Code 配置文件
if [[ -f /vscode/claude-config/.claude.json ]]; then
  echo "Claude Code 配置文件 (.claude.json) 已存在，跳过覆盖。"
else
  echo "$CLAUDE_JSON_CONTENT" > /vscode/claude-config/.claude.json
fi

# >>>>> Claude Code 设置文件
if [[ -f /vscode/claude-config/settings.json ]]; then
  echo "Claude Code 设置文件 (settings.json) 已存在，跳过覆盖。"
else
  echo "$SETTINGS_JSON_CONTENT" > /vscode/claude-config/settings.json
fi
