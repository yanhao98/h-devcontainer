#!/bin/bash
#-------------------------------------------------------------------------------------------------------------
# https://github.com/devcontainers/features/blob/main/src/desktop-lite/install.sh
#-------------------------------------------------------------------------------------------------------------
set -euo pipefail

curl -fsSL https://Git.1-H.CC/Scripts/Linux/raw/branch/2026/devcontainer/apt-install-with-cache.sh | sudo bash -s -- \
    tigervnc-standalone-server tigervnc-common tigervnc-tools \
    fluxbox dbus-x11 x11-utils x11-xserver-utils xdg-utils fbautostart \
    at-spi2-core xterm nautilus mousepad seahorse \
    gnome-icon-theme gnome-keyring \
    libx11-dev libxkbfile-dev libsecret-1-dev libgbm-dev libnotify4 \
    libnss3 libxss1 libasound2 libasound2-dev \
    xfonts-base xfonts-terminus fonts-noto fonts-wqy-microhei fonts-droid-fallback fonts-noto-color-emoji \
    htop ncdu curl ca-certificates unzip nano locales \
    python3-minimal python3-numpy \
    tilix

echo "正在从 GitHub 获取并执行 desktop-lite 安装脚本..."

# 使用 curl 下载并执行远程脚本，同时移除清理 apt 缓存的命令
curl -sSL https://raw.githubusercontent.com/devcontainers/features/main/src/desktop-lite/install.sh | \
  sed '\#rm -rf /var/lib/apt/lists/\*#d' | \
  sed 's#unzip /tmp#unzip -q /tmp#g' | \
  sudo bash

# TigerVNC 出于安全考虑，拒绝在没有密码保护的情况下允许外部连接（非 localhost）。
# 允许非本地连接 VNC，并添加不安全连接确认标志
sudo sed -i 's/ -localhost / -localhost no --I-KNOW-THIS-IS-INSECURE /g' /usr/local/share/desktop-init.sh

# 将名为 VNC-0 的虚拟显示器的分辨率设置为 1920x1200
# xrandr --output VNC-0 --mode 1920x1200

# 启动桌面进程
nohup setsid /usr/local/share/desktop-init.sh >/dev/null 2>&1 &
# postStartCommand 完成后，VS Code 会终止其所有子进程（包括后台启动的 VNC 服务器）。
# - nohup: 忽略 SIGHUP 信号
# - setsid: 创建新的 session，进程成为 session leader，完全脱离原终端/进程组
# 另外，keepRunningInBackground() 函数内部的 ( ... & ...) 也可能需要类似处理，但先试试改外层脚本，看是否足够。
